---
title: "Persistent recovery gap in soil fungal communities after vegetation restoration: a meta-analysis"
format:
  html:
    toc: true
    toc-depth: 4          
    toc-title: "Table of contents"
    number-sections: true
    code-fold: false
    theme: default
    fontsize: 0.7em
    toc-location: left
---

# [Chapter I]{style="color: blue;"}

## Software installation

::: {style="background-color:#f0f0f0;"}
1.  Download and install R v 4.4.0 (<https://cloud.r-project.org>)

2.  Download and install Positron IDE v 2025.11.0 build 234 (<https://positron.posit.co/download.html>)

3.  Download and install Quarto v 1.8.26 (<https://quarto.org/docs/get-started/>)

4.  Installation of Datathief <https://datathief.org> and download link is <https://datathief.org/Datathief.jar> . (Note: To run this software, computer must support JavaScript)
:::

# [Chapter II]{style="color: blue;"}

## Literature search

::: {style="background-color:#f0f0f0;"}
The literature search was carried out in the Web of Science Core Collection (<https://www.webofscience.com/>). Using the **Advanced Search** option, the following Boolean keyword combinations were applied to identify relevant studies. The retrieved literature was then manually sorted based on inclusion/exclusion criteria provided in Methods ("Literature search").

**First search**

TS=((Fungi) AND (restor\* OR "eco-restor\*" OR ecorestor\* OR revegetat\* OR "re-vegetat" OR plantation\* OR replant\* OR "re-plant\*" OR afforest\* OR reforest\* OR "re-forest" OR reclam\* OR "re-calm\*" OR rewild\* OR "re-wild\*" OR rehabilitat\* OR "re-habilitat\*" OR remediate\* OR recover\* OR reintroduc\* OR "re-introduc" OR abandon\* OR succession\*) AND (soil\* OR root\*) AND (diversity\* OR richness\* OR evenness\* OR relative abundan\* OR abundan\* OR composition\* OR community\* OR network\* OR biomass\* OR PLFA\* OR glomalin\* OR spore density\* OR colonization\* OR propagule\* OR hypha\* OR colony\* OR abundance\* OR phylogen\* OR gene copy\*) AND (ecolog\* OR environment\* OR ecosystem\*))

**Second search**

TS=((Fungi OR "soil fungi" OR microbe\* OR microorganism\* OR microbiome OR mycobiome OR mycobiota OR "fungal communit\*" OR "soil microfungi" OR "soil mycota") AND (restor\* OR "eco-restor" OR ecorestor OR revegetat\* OR "re-vegetat" OR plantation\* OR replant\* OR "re-plant" OR afforest OR reforest\* OR "re-forest" OR reclam\* OR "re-calm" OR rewild OR "re-wild" OR rehabilitat OR "re-habilitat" OR remediate OR recover\* OR reintroduc\* OR "re-introduc" OR abandon\* OR succession) AND (soil) AND (diversity OR richness\* OR evenness\* OR "relative abundan\*" OR abundan\* OR biomass\* OR PLFA) AND (NGS\* OR "high-throughput" OR metagenom\* OR amplicon\* OR "next-generation sequencing" OR Illumina OR MiSeq OR IonTorrent OR PacBio OR Nanopore OR 454 OR "ITS" OR "18S") AND (ecolog OR environment\* OR ecosystem\*))
:::

# [Chapter III]{style="color: blue;"}

The following steps can be executed on all types of computers, including **macOS, Linux, and Windows**.

R version 4.4.0 (2024-04-24)

## Install required packages

```{r eval = FALSE}
install.packages(c(
  "metafor", "numDeriv", "metadat", "Matrix", "gridExtra",
  "dplyr", "forcats", "sf", "maps", "ggplot2"
))
```

These following packages will automatically loaded as dependencies, but it can be installed if needed.

```{r eval = FALSE}
install.packages(c(
  "gtable", "crayon", "tidyselect", "Rcpp", "dichromat",
  "systemfonts", "scales", "textshaping", "lattice", "R6",
  "labeling", "generics", "classInt", "tibble", "units",
  "DBI", "pillar", "RColorBrewer", "rlang", "utf8",
  "mathjaxr", "S7", "cli", "withr", "magrittr", "class",
  "digest", "nlme", "lifecycle", "vctrs", "KernSmooth",
  "proxy", "glue", "farver", "ragg", "e1071", "pkgconfig"
))
```

## Load all required packages

```{r message = FALSE}
library(metafor)
library(numDeriv)
library(metadat)
library(Matrix)
library(gridExtra)
library(dplyr)
library(forcats)
library(sf)
library(maps)
library(ggplot2)
library(stats)
library(graphics)
library(grDevices)
library(utils)
library(datasets)
library(methods)
library(grid)
```

# [Chapter IV]{style="color: blue;"}

## Data extraction step

### Data extraction from tables

If reported, the relevant table was located, and the data were extracted.

### Data extraction from figures (boxplot, barplot etc.)

Before the extraction procedure, the figures available in the selected publication needed to be downloaded and saved. Here, an example figure was saved in the `Data_folder/example_shinyDigitise`.

#### Installation of shinyDigitise

The installation steps are available at this link <https://github.com/EIvimeyCook/ShinyDigitise> .

#### Load required package

```{r message = FALSE}
library(shinyDigitise)
```

#### Run shinyDigitise

```{r eval = FALSE}
getwd()
shinyDigitise("./Data_folder/example_shinyDigitise") #Use absolute path if this do not open floating window correctly
```

A floating window will be opened, and the subsequent steps should be followed.

![](images/shiny1.png){fig-align="center" width="259"}

For example, here is the example of figure.png loaded after clicking `GET EXTRACTING`.

![](images/shiny2.png){fig-align="center" width="280"}

The following steps have to be followed: **Orientate Figure → Calibrate Axes → Extract Data**. Upon completion, a message will be displayed in the R console.

### Data extraction from community structure (ordination plot)

#### Open figure in Datathief

This step was performed outside the R environment. The **Datathief.jar** file was opened, which launched a window as shown below:

![](images/Datathief1.png){fig-align="center" width="297"}

#### Manual extraction of coordinates

The ordination plot saved in the folder was opened. The axes were then calibrated by moving the "brown," "blue," and "green" points and entering the corresponding x-axis and y-axis coordinates for all three points. To obtain the coordinates of each individual point in the plot, each moving point was adjusted to the respective location, and the coordinates were recorded manually. These coordinates are provided in Supplementary Table S3 under the **Axis1** and **Axis2** columns.

![](images/Datatheif2.png){fig-align="center" width="333"}

#### Calculation of euclidean distance

##### Data preparation

The data should consist of three columns: **Plot**, **Axis1**, and **Axis2**, containing the coordinates of each point. For example, as provided in `Data_folder/example_DataThief/ordination_point.csv`, the `df` dataset should appear as follows:

![](images/ordination_point.png){fig-align="center" width="210"}

Smilarly plot category data `Data_folder/example_DataThief/ordination_point_category.csv` should look like:

![](images/ordination_point_category.png){fig-align="center" width="167"}

##### Load required packages

```{r}
library(vegan)
```

##### Calculation step

```{r}
# Import df data
df<- read.csv(file = "Data_folder/example_DataThief/ordination_point.csv", header = TRUE, row.names = 1)

# Calculate Euclidean distance matrix
dist_mat<- vegdist(df, method = "euclidean")
dist_matrix<- as.matrix(dist_mat)

# Copy plot category table from excel sheet
# Read group plot category from clipboard
comparison<- read.csv(file = "Data_folder/example_DataThief/ordination_point_category.csv", header = TRUE, row.names = 1)

# Get unique comparison types
comparison_types <- unique(unlist(comparison))

# Calculate WITHIN-group distances
within_distances <- list()
for (type in comparison_types) {
  samples<- rownames(comparison)[comparison[, 1] == type]
  if (length(samples) > 1) {
    sub_dist <- dist_matrix[samples, samples]
    within_distances[[type]] <- sub_dist[upper.tri(sub_dist)]  # Get upper triangle (no duplicates)
  }
}

# Calculate mean and SD for within-group distances
mean_within <- sapply(within_distances, mean)
sd_within   <- sapply(within_distances, sd)

# Calculate BETWEEN-group distances
type_pairs <- combn(comparison_types, 2, simplify = FALSE)  # All possible pairs
between_distances <- list()
for (pair in type_pairs) {
  type1   <- pair[1]
  type2   <- pair[2]
  samples1 <- rownames(comparison)[comparison[, 1] == type1]
  samples2 <- rownames(comparison)[comparison[, 1] == type2]
  between_distances[[paste(type1, type2, sep = "_vs_")]] <-
    as.vector(dist_matrix[samples1, samples2])  # All distances between groups
}

# Calculate mean and SD for between-group distances
mean_between <- sapply(between_distances, mean)
sd_between   <- sapply(between_distances, sd) 

# Compile results
result <- list(
  mean_within_groups = mean_within,
  sd_within_groups   = sd_within,
  mean_between_groups = mean_between,
  sd_between_groups   = sd_between
)
result
```

From the results displayed in the R console, the relevant data were copied. These data are presented in Supplementary Table S3. The same steps were repeated for all relevant studies, and the final datasets were obtained as `Data_folder/community_structure/composition.csv` and `Data_folder/community_structure/beta_diversity.csv`.

# [Chapter V]{style="color: blue;"}

## Study distribution map and overview of data

### Load required packages

```{r}
library(ggplot2)
library(maps)
library(sf)
library(grid)
library(forcats)
library(dplyr)
```

### Import coordinate data

```{r}
# Read location data from tab-separated file
location <- read.table("Data_folder/data_overview/study_distribution.txt", header = TRUE, sep = "\t") 

# Standardize restoration activity labels
location$Restoration_activity[location$Restoration_activity == "Active"] <- "Active restoration"
location$Restoration_activity[location$Restoration_activity == "Passive"] <- "Natural regeneration"
```

### Map with study distribution

```{r}
world_map <- map_data("world")
facets <- unique(location$Restoration_activity)

world_map_facet <- world_map %>% slice(rep(seq_len(n()), length(facets))) %>% mutate(Restoration_activity = rep(facets, each = nrow(world_map)))

base_world_with_grid <- ggplot() + geom_polygon(data = world_map_facet, aes(x = long, y = lat, group = group), fill = "lightblue", color = "transparent") + coord_sf(crs = 4326, xlim = c(-160, 175), ylim = c(-55, 80), expand = FALSE) + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), panel.border = element_blank()) + labs(x = NULL, y = NULL)

location$Ecosystem <- factor(location$Ecosystem, levels = c("Grassland", "Shrubland", "Forest", "Desert"))

location$Past_disturbance_type <- factor( location$Past_disturbance_type, levels = c("Agriculture", "Pasture", "Mining", "Deforestation", "Erosion", "Monoculture plantation", "Others"))

map_with_points <- base_world_with_grid + geom_point(data = location, aes(x = Longitude, y = Latitude, fill = Past_disturbance_type, shape = Ecosystem), size = 1, alpha = 0.5, color = "black", stroke = 0.3) + scale_fill_manual(values = c("Agriculture" = "red", "Pasture" = "blue", "Mining" = "darkgreen", "Deforestation" = "orange", "Erosion" = "brown", "Monoculture plantation" = "cyan", "Others" = "yellow")) + scale_shape_manual(values = c("Grassland" = 21, "Shrubland" = 24, "Forest" = 22, "Desert" = 23)) + labs(fill = "Past disturbance", shape = "Ecosystem") + theme(legend.title = element_text(size = 10), legend.text = element_text(size = 8), legend.position = "right", strip.text = element_blank()) + facet_wrap(~Restoration_activity, nrow = 2) + guides(fill = guide_legend(override.aes = list(shape = 21, color = "black", size = 2.5), keyheight = unit(0.3, "cm"), keywidth = unit(0.8, "cm")), shape = guide_legend(override.aes = list(fill = "black", color = "black", size = 2.5), keyheight = unit(0.3, "cm"), keywidth = unit(0.8, "cm")))
```

### Data overview

```{r}
# Read data overview CSV file
data_overview <- read.csv("Data_folder/data_overview/data_overview.csv", header = TRUE)

# Reorder Types by number of Studies within each Overview category
data_overview_ordered <- data_overview %>% group_by(Overview) %>% mutate(Types = fct_reorder(Types, Studies)) %>% ungroup()

# Convert to factors for proper plotting
data_overview_ordered$Overview <- as.factor(data_overview_ordered$Overview)
data_overview_ordered$Types <- as.factor(data_overview_ordered$Types)

# Split data into three categories for separate plots/analysis
restoration_strategy_overview <- data_overview_ordered[data_overview_ordered$Overview == "Restoration strategy",]
past_disturbance_overview <- data_overview_ordered[data_overview_ordered$Overview == "Past disturbance",]
ecosystem_overview <- data_overview_ordered[data_overview_ordered$Overview == "Ecosystem",]

# horizontal bar plot for restoration strategy overview
restoration_strategy_overview_plot <- ggplot(restoration_strategy_overview, aes(x = Studies, y = forcats::fct_reorder(Types, Studies))) + geom_bar(stat = "identity", alpha = 0.8, fill = "grey90", width = 0.5) + geom_text(aes(label = Studies), hjust = -0.1, size = 3.5) + labs(title = "Restoration strategy", x = NULL, y = NULL) + theme_classic() + theme(plot.title = element_text(hjust = 0.5, face = "plain", size = 10), axis.text.x = element_blank(), axis.title.y = element_text(size = 10, vjust = 0), panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(), axis.line.y = element_line(linewidth = 0.1, color = "grey50"), axis.line.x = element_line(linewidth = 0.1, color = "grey50"), axis.ticks.x = element_line(linewidth = 0.1, color = "grey50"), plot.margin = margin(t = 10, r = 10, b = 80, l = 10, unit = "pt")) + scale_x_continuous(expand = expansion(mult = c(0, 0.2)), position = "top")

# horizontal bar plot for past disturbance overview
distrubance_overview_plot <- ggplot(past_disturbance_overview, aes(x = Studies, y = forcats::fct_reorder(Types, Studies))) + geom_bar(stat = "identity", alpha = 0.8, fill = "grey90", width = 0.5) + geom_text(aes(label = Studies), hjust = -0.1, size = 3.5) + labs(title = "Past distrubance", x = NULL, y = NULL) + theme_classic() + theme(plot.title = element_text(hjust = 0.5, face = "plain", size = 10), axis.title.y = element_text(size = 10, vjust = 0), axis.text.x = element_blank(), panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(), axis.line.y = element_line(linewidth = 0.1, color = "grey50"), axis.line.x = element_line(linewidth = 0.1, color = "grey50"), axis.ticks.x = element_line(linewidth = 0.1, color = "grey50")) + scale_x_continuous(expand = expansion(mult = c(0, 0.2)), position = "top")

# horizontal bar plot for ecosystem overview
ecosystem_overview_plot <- ggplot(ecosystem_overview, aes(x = Studies, y = forcats::fct_reorder(Types, Studies))) + geom_bar(stat = "identity", alpha = 0.8, fill = "grey90", width = 0.5) + geom_text(aes(label = Studies), hjust = -0.1, size = 3.5) + labs(title = "Ecosystem", x = NULL, y = NULL) + theme_classic() + theme(plot.title = element_text(hjust = 0.5, face = "plain", size = 10), axis.title.x = element_text(size = 10, vjust = 0), axis.text.y = element_text(size = 10), axis.text.x = element_blank(), panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(), axis.line.y = element_line(linewidth = 0.1, color = "grey50"), axis.line.x = element_line(linewidth = 0.1, color = "grey50"), axis.ticks.x = element_line(linewidth = 0.1, color = "grey50"), plot.margin = margin(t = 10, r = 10, b = 40, l = 10, unit = "pt")) + scale_x_continuous(expand = expansion(mult = c(0, 0.2)), position = "top") 
```

### Figure 1

```{r}
# Arrange the three overview plots
plot_overview <- grid.arrange(ecosystem_overview_plot, distrubance_overview_plot,restoration_strategy_overview_plot, ncol = 3)

# Combine map with overview plots
plot_overview_map <- grid.arrange(map_with_points,  plot_overview, nrow = 2, heights = c(3, 1))
```

```{r eval = FALSE}
# Save combined figure
ggsave("Figure_1.tiff", plot =  plot_overview_map, dpi = 600, height = 8, width = 8.5)
```

# [Chapter VI]{style="color: blue;"}

## Data overview detail figures

### Restoration strategies

```{r}
# Read restoration comparison data
data_overview_restoration <- read.csv("Data_folder/data_overview/data_overview_restoration_comparison.csv", header = TRUE)

# Set factor levels for consistent ordering
data_overview_restoration$Metrics <- factor(data_overview_restoration$Metrics, levels = c("Observed richness","Chao1 richness","Shannon index","Simpson index", "Ascomycota","Basidiomycota","Composition","PLFA content"))

data_overview_restoration$Restoration_activity <- factor(data_overview_restoration$Restoration_activity, levels = c("Active restoration", "Natural regeneration"))

# Set threshold for breaking lines when values are too high
break_threshold <- 50 

# Prepare data for broken bar segments
data_segmented_restoration <- data_overview_restoration %>% mutate(needs_break = Comparison > break_threshold, segment_end = ifelse(needs_break, break_threshold * 0.9, Comparison))

# Calculate positions with proper spacing
max_metrics <- max(as.numeric(factor(data_segmented_restoration$Metrics)))
spacing_multiplier <- 3

# Create spread out x-positions for metrics
data_segmented_restoration <- data_segmented_restoration %>% mutate(x_position = (as.numeric(factor(Metrics)) - 1) * spacing_multiplier + 1)

# Calculate plot limits
min_x <- min(data_segmented_restoration$x_position) - 1
max_x <- max(data_segmented_restoration$x_position) + 1
center_x <- (min_x + max_x) / 2 

# Create lollipop plot with broken segments for high values
overview_restoration <- ggplot(data_segmented_restoration, aes(x = center_x, y = 0)) + geom_segment(aes(xend = x_position, yend = segment_end, color = Metrics), size = 1, lineend = "round") +geom_segment(data = subset(data_segmented_restoration, needs_break == TRUE), aes(x = x_position, xend = x_position, y = break_threshold * 1.1, yend = break_threshold * 1.1 + (Comparison - break_threshold) * 0.3, color = Metrics),size = 1, lineend = "round") + geom_hline(yintercept = 0, color = "black", size = 0.2) +  geom_point(data = subset(data_segmented_restoration, needs_break == TRUE), aes(x = x_position, y = break_threshold),             shape = 21, fill = "white", color = "transparent", size = 2) + geom_text(data = subset(data_segmented_restoration, needs_break == TRUE), aes(x = x_position, y = break_threshold * 1.1 + (Comparison - break_threshold) * 0.3, label = Comparison), vjust = -0.8, size = 2.5) + geom_text(data = subset(data_segmented_restoration, !needs_break), aes(x = x_position, y = Comparison, label = Comparison), vjust = -0.8, size = 2.5) + facet_wrap(~ Restoration_activity, nrow = 1, strip.position = "bottom") +  labs(x = NULL, y = NULL, color = NULL) +  scale_color_manual(values = c( "Observed richness" = "darkgreen", "Chao1 richness" = "limegreen",       "Shannon index" = "springgreen", "Simpson index" = "cyan3",  "Ascomycota" = "orange", "Basidiomycota" = "brown", "Composition" = "steelblue", "PLFA content" = "grey60" )) + theme_bw() + theme(legend.position = "none", legend.text = element_text(size = 6),        axis.text = element_blank(), axis.ticks = element_blank(), axis.line = element_blank(), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), strip.background = element_blank(), strip.text = element_text(color = "black"), panel.spacing.x = unit(0.2, "cm"), panel.spacing.y = unit(-0.5, "cm"), plot.margin = margin(0, 0, 0, 0, "pt")) + coord_cartesian(xlim = c(min_x, max_x), ylim = c(0, max(data_segmented_restoration$Comparison) * 0.6))
```

### Ecosystem types

```{r}
data_overview <- read.csv("Data_folder/data_overview/data_overview_forest_comparison.csv", header = TRUE)

data_overview$Metrics <- factor(data_overview$Metrics, levels = c("Observed richness","Chao1 richness","Shannon index","Simpson index", "Ascomycota","Basidiomycota", "Composition","PLFA content"))

data_overview$Ecosystem <- factor(data_overview$Ecosystem,  levels = c("Forest","Grassland","Shrubland","Desert"))

# Use the correct dataset name
break_threshold <- 50

data_segmented_ecosystem <- data_overview %>% mutate(needs_break = Comparison > break_threshold, segment_end = ifelse(needs_break, break_threshold * 0.9, Comparison))

# Calculate positions with proper spacing
max_metrics <- max(as.numeric(factor(data_segmented_ecosystem$Metrics)))
spacing_multiplier <- 3

# Create more spread out x-positions
data_segmented_ecosystem <- data_segmented_ecosystem %>% mutate(x_position = (as.numeric(factor(Metrics)) - 1) * spacing_multiplier + 1)

# Calculate automatic limits based on the actual data
min_x <- min(data_segmented_ecosystem$x_position) - 1
max_x <- max(data_segmented_ecosystem$x_position) + 1
center_x <- (min_x + max_x) / 2 

overview_ecosystem <- ggplot(data_segmented_ecosystem, aes(x = center_x, y = 0)) + geom_segment(aes(xend = x_position, yend = segment_end, color = Metrics), size = 1, lineend = "round") + geom_segment(data = subset(data_segmented_ecosystem, needs_break == TRUE), aes(x = x_position, xend = x_position, y = break_threshold * 1.1, yend = break_threshold * 1.1 + (Comparison - break_threshold) * 0.3, color = Metrics), size = 1, lineend = "round") + geom_hline(yintercept = 0, color = "black", size = 0.2) + geom_point(data = subset(data_segmented_ecosystem, needs_break == TRUE), aes(x = x_position, y = break_threshold), shape = 21, fill = "white", color = "transparent", size = 2) + geom_text(data = subset(data_segmented_ecosystem, needs_break == TRUE), aes(x = x_position, y = break_threshold * 1.1 + (Comparison - break_threshold) * 0.3, label = Comparison), vjust = -0.8, size = 2.5) + geom_text(data = subset(data_segmented_ecosystem, !needs_break), aes(x = x_position, y = Comparison, label = Comparison), vjust = -0.8, size = 2.5) + facet_wrap(~ Ecosystem, nrow = 1, strip.position = "bottom") + labs(x = NULL, y = NULL, color = NULL) + scale_color_manual(values = c("Observed richness" = "darkgreen", "Chao1 richness" = "limegreen", "Shannon index" = "springgreen", "Simpson index" = "cyan3", "Ascomycota" = "orange", "Basidiomycota" = "brown", "Composition" = "steelblue", "PLFA content" = "grey60")) + theme_bw() + theme(legend.position = "none", legend.text = element_text(size = 6), axis.text = element_blank(), axis.ticks = element_blank(), axis.line = element_blank(), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), strip.background = element_blank(), strip.text = element_text(color = "black"), panel.spacing.x = unit(0.2, "cm"), panel.spacing.y = unit(-0.5, "cm"), plot.margin = margin(0, 0, 0, 0, "pt")) + coord_cartesian(xlim = c(min_x, max_x), ylim = c(0, max(data_segmented_ecosystem$Comparison) * 0.6))
```

### Past disturbance types

```{r}
data_overview_past_disturbance <- read.csv("Data_folder/data_overview/data_overview_past_disturbance.csv", header = TRUE)

data_overview_past_disturbance$Metrics <- factor(data_overview_past_disturbance$Metrics, levels = c("Observed richness", "Chao1 richness","Shannon index", "Simpson index","Ascomycota", "Basidiomycota","Composition","PLFA content"))

data_overview_past_disturbance$Past_disturbance <- factor(data_overview_past_disturbance$Past_disturbance, levels = c("Agriculture", "Deforestation", "Erosion", "Mining","Monoculture plantation", "Pasture","Others"))

# Use the correct dataset name
break_threshold <- 50

data_segmented_past_disturbance <- data_overview_past_disturbance %>% mutate(needs_break = Comparison > break_threshold, segment_end = ifelse(needs_break, break_threshold * 0.9, Comparison))

# Calculate positions with proper spacing
max_metrics <- max(as.numeric(factor(data_segmented_past_disturbance$Metrics)))
spacing_multiplier <- 3

# Create more spread out x-positions
data_segmented_past_disturbance <- data_segmented_past_disturbance %>% mutate(x_position = (as.numeric(factor(Metrics)) - 1) * spacing_multiplier + 1)

# Calculate automatic limits based on the actual data
min_x <- min(data_segmented_past_disturbance$x_position) - 1
max_x <- max(data_segmented_past_disturbance$x_position) + 1
center_x <- (min_x + max_x) / 2 

overview_past_disturbance <- ggplot(data_segmented_past_disturbance, aes(x = center_x, y = 0)) + geom_segment(aes(xend = x_position, yend = segment_end, color = Metrics), size = 1, lineend = "round") + geom_segment(data = subset(data_segmented_past_disturbance, needs_break == TRUE), aes(x = x_position, xend = x_position, y = break_threshold * 1.1, yend = break_threshold * 1.1 + (Comparison - break_threshold) * 0.3, color = Metrics), size = 1, lineend = "round") + geom_hline(yintercept = 0, color = "black", size = 0.2) + geom_point(data = subset(data_segmented_past_disturbance, needs_break == TRUE), aes(x = x_position, y = break_threshold), shape = 21, fill = "white", color = "transparent", size = 2) + geom_text(data = subset(data_segmented_past_disturbance, needs_break == TRUE), aes(x = x_position, y = break_threshold * 1.1 + (Comparison - break_threshold) * 0.3, label = Comparison), vjust = -0.8, size = 2.5) + geom_text(data = subset(data_segmented_past_disturbance, !needs_break), aes(x = x_position, y = Comparison, label = Comparison), vjust = -0.8, size = 2.5) + facet_wrap(~ Past_disturbance, nrow = 1, strip.position = "bottom") + labs(x = NULL, y = NULL, color = NULL) + scale_color_manual(values = c("Observed richness" = "darkgreen", "Chao1 richness" = "limegreen", "Shannon index" = "springgreen", "Simpson index" = "cyan3", "Ascomycota" = "orange", "Basidiomycota" = "brown", "Composition" = "steelblue", "PLFA content" = "grey60")) + theme_bw() + theme(legend.position = "bottom", legend.text = element_text(size = 8), axis.text = element_blank(), axis.ticks = element_blank(), axis.line = element_blank(), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), strip.background = element_blank(), strip.text = element_text(color = "black"), panel.spacing.x = unit(0.2, "cm"), panel.spacing.y = unit(-0.5, "cm"), plot.margin = margin(0, 0, 0, 0, "pt")) + coord_cartesian(xlim = c(min_x, max_x), ylim = c(0, max(data_segmented_past_disturbance$Comparison) * 1))
```

### Figure S2

```{r}
# Combine restoration and ecosystem overview plots side by side
Figure_S2_1 <- grid.arrange(overview_restoration, overview_ecosystem, nrow = 1, widths = c(0.6, 1))

# Add past disturbance overview below the first combination
Figure_S2_2 <- grid.arrange(Figure_S2_1, overview_past_disturbance, nrow = 2)
```

```{r eval = FALSE}
# Save the final combined overview figure
ggsave("overview.tiff", plot =  Figure_S2_2, dpi = 600, height = 6, width = 9)
```

### Restoration time

```{r}
location_time <- read.table("Data_folder/data_overview/location_restoration_time.txt", header = TRUE, sep = "\t") 

location_time$Group <- factor(location_time$Group, levels = c("< 10 years", "10 to 20 years", "20 to 30 years", "30 to 40 years", "> 40 years"))                       

bar_plot <- location_time %>% count(Group) %>% ggplot(aes(x = Group, y = n)) + geom_col(color = "black", linewidth = 0.25, fill = "grey80", width = 0.7) + geom_text(aes(label = n), vjust = -0.5, size = 3.5, fontface = "plain") + labs(y = "Number of studies", x = "Restoration time") + theme_bw() + theme(plot.title = element_blank(), axis.title = element_text(size = 12, face = "plain", color = "black"), axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)), axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)), axis.text = element_text(size = 10, color = "black"), axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.border = element_rect(color = "black", linewidth = 0.5), plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"), legend.position = "none") + scale_y_continuous(expand = expansion(mult = c(0, 0.1)))

bar_plot
```

### Figure S3

```{r eval = FALSE}
ggsave("Figure_S3.tiff", plot =  bar_plot, dpi = 600, height = 6, width = 5) 
```

# [Chapter VII]{style="color: blue;"}

## Response ratio calculation

### Import data

#### Alpha diversity

```{r}
alpha_resVsdeg <- read.csv("Data_folder/alpha_diversity/alpha_diversity_resVsdeg.csv", header = TRUE) %>% mutate(across(c(ID, Restoration_strategy, Ecosystem, Past_disturbance_type), as.factor), Restoration_time = as.numeric(Restoration_time))

alpha_resVsref <- read.csv("Data_folder/alpha_diversity/alpha_diversity_resVsref.csv", header = TRUE) %>% mutate(across(c(ID, Restoration_strategy, Ecosystem, Past_disturbance_type), as.factor), Restoration_time = as.numeric(Restoration_time))

OTU_resVsdeg <- alpha_resVsdeg[1:191,]
Chao_resVsdeg <- alpha_resVsdeg[192:407,]
Shannon_resVsdeg <- alpha_resVsdeg[408:709,]
Simpson_resVsdeg <- alpha_resVsdeg[710:799,]
OTU_resVsref <- alpha_resVsref[1:79,]
Chao_resVsref <- alpha_resVsref[80:154,]
Shannon_resVsref <- alpha_resVsref[155:289,]
Simpson_resVsref <- alpha_resVsref[290:341,]
```

#### Composition

```{r}
beta <- read.csv("Data_folder/community_structure/beta_diversity.csv", header = TRUE) %>% mutate(across(c(ID, Restoration_strategy, Ecosystem, Past_disturbance_type), as.factor), Restoration_time = as.numeric(Restoration_time))

structure <- read.csv("Data_folder/community_structure/composition.csv", header = TRUE) %>% mutate(across(c(ID, Restoration_strategy, Ecosystem, Past_disturbance_type), as.factor), Restoration_time = as.numeric(Restoration_time))

beta_diversity_degraded <- beta %>% filter(Comparison == "Restored vs Degraded")
beta_diversity_reference <- beta %>% filter(Comparison == "Restored vs Reference")
structure_degraded <- structure %>% filter(Comparison == "Restored vs Degraded")
structure_reference <- structure %>% filter(Comparison == "Restored vs Reference")

composition_raw_degraded <- bind_rows(beta_diversity_degraded, structure_degraded)
composition_raw_reference <- bind_rows(beta_diversity_reference, structure_reference)
```

#### Relative abundance

```{r}
Ascomycota_deg <- read.csv("Data_folder/relative_abundance/ascomycota_resVsdeg.csv", header = TRUE) %>%  mutate(across(c(ID, Restoration_strategy, Ecosystem, Past_disturbance_type), as.factor), Restoration_time = as.numeric(Restoration_time))

Ascomycota_ref <- read.csv("Data_folder/relative_abundance/ascomycota_resVsref.csv", header = TRUE) %>% mutate(across(c(ID, Restoration_strategy, Ecosystem, Past_disturbance_type), as.factor), Restoration_time = as.numeric(Restoration_time))

Basidiomycota_deg <- read.csv("Data_folder/relative_abundance/basidiomycota_resVsdeg.csv", header = TRUE) %>% mutate(across(c(ID, Restoration_strategy, Ecosystem, Past_disturbance_type), as.factor), Restoration_time = as.numeric(Restoration_time)) 

Basidiomycota_ref <- read.csv("Data_folder/relative_abundance/basidiomycota_resVsref.csv", header = TRUE) %>% mutate(across(c(ID, Restoration_strategy, Ecosystem, Past_disturbance_type), as.factor), Restoration_time = as.numeric(Restoration_time))

abundance_raw_degraded <- bind_rows(Ascomycota_deg, Basidiomycota_deg)
abundance_raw_reference <- bind_rows(Ascomycota_ref, Basidiomycota_ref)
```

#### Biomass

```{r}
PLFA_degraded <- read.csv("Data_folder/biomass/plfa_resVsdeg.csv", header = TRUE) %>% mutate(across(c(ID, Restoration_strategy, Ecosystem, Past_disturbance_type), as.factor), Restoration_time = as.numeric(Restoration_time))

PLFA_reference <- read.csv("Data_folder/biomass/plfa_resVsref.csv", header = TRUE) %>% mutate(across(c(ID, Restoration_strategy, Ecosystem, Past_disturbance_type), as.factor), Restoration_time = as.numeric(Restoration_time))
```

### Calculation

#### Load required packages

```{r}
library(metafor)
```

#### Function to calculate response ratio

```{r}
calculate_resVsdeg <- function(data, n1i, n2i, m1i, m2i, sd1i, sd2i) {
  escalc(measure = "ROM", n1i = Restored_SS, n2i = Degraded_SS, m1i = Restored_Mean, m2i = Degraded_Mean, sd1i = Restored_SD, sd2i = Degraded_SD, data = data, append = TRUE)}

calculate_resVsref <- function(data, n1i, n2i, m1i, m2i, sd1i, sd2i) {escalc(measure = "ROM", n1i = Restored_SS, n2i = Reference_SS, m1i = Restored_Mean, m2i = Reference_Mean, sd1i = Restored_SD, sd2i = Reference_SD, data = data, append = TRUE)}
```

#### Alpha diversity

```{r}
# Observed richness Restored vs Degraded
a_OTU_resVsdeg <- calculate_resVsdeg(OTU_resVsdeg, Restored_SS, Degraded_SS, Restored_Mean, Degraded_Mean, Restored_SD, Degraded_SD)

# Chao1 richness Restored vs Degraded
a_Chao_resVsdeg <- calculate_resVsdeg(Chao_resVsdeg, Restored_SS, Degraded_SS,  Restored_Mean, Degraded_Mean, Restored_SD, Degraded_SD)

# Shannon index Restored vs Degraded 
a_Shannon_resVsdeg <- calculate_resVsdeg(Shannon_resVsdeg, Restored_SS, Degraded_SS, Restored_Mean, Degraded_Mean, Restored_SD, Degraded_SD)

# Simpson index Restored vs Degraded
a_Simpson_resVsdeg <- calculate_resVsdeg(Simpson_resVsdeg, Restored_SS, Degraded_SS, Restored_Mean, Degraded_Mean, Restored_SD, Degraded_SD)

# Observed richness Restored vs Reference
a_OTU_resVsref <- calculate_resVsref(OTU_resVsref, Restored_SS, Reference_SS, Restored_Mean,Reference_Mean, Restored_SD, Reference_SD)

# Chao1 richness Restored vs Reference
a_Chao_resVsref <- calculate_resVsref(Chao_resVsref, Restored_SS, Reference_SS, Restored_Mean, Reference_Mean, Restored_SD, Reference_SD)

# Shannon index Restored vs Reference
a_Shannon_resVsref <- calculate_resVsref(Shannon_resVsref, Restored_SS, Reference_SS, Restored_Mean,  Reference_Mean, Restored_SD, Reference_SD)

# Simpson index Restored vs Reference
a_Simpson_resVsref <- calculate_resVsref(Simpson_resVsref, Restored_SS, Reference_SS, Restored_Mean,  Reference_Mean, Restored_SD, Reference_SD)

# Filter some extreme lnRR
a_OTU_resVsdeg <- a_OTU_resVsdeg[-c(6, 7, 17, 18, 19, 111, 168, 172), ] 
a_Chao_resVsdeg <- a_Chao_resVsdeg[-c(21, 25, 27, 98, 151, 203), ]
a_Shannon_resVsdeg <- a_Shannon_resVsdeg[-c(1, 2, 3, 124, 202), ]

# Combine all response ratio data
alpha_diversity_deg_raw <- rbind(a_OTU_resVsdeg, a_Chao_resVsdeg,a_Shannon_resVsdeg, a_Simpson_resVsdeg )
alpha_diversity_ref_raw <- rbind(a_OTU_resVsref, a_Chao_resVsref,a_Shannon_resVsref, a_Simpson_resVsref )
```

#### Composition

```{r}
# Composition data already have lnRR and variance (vi)
```

#### Relative abundance

```{r}
# Ascomycota Restored vs Degraded
a_Ascomycota_degraded <- calculate_resVsdeg(Ascomycota_deg, Restored_SS, Degraded_SS, Restored_Mean, Degraded_Mean, Restored_SD, Degraded_SD)

# Ascomycota Restored vs Reference
a_Ascomycota_reference <- calculate_resVsref(Ascomycota_ref, Restored_SS, Degraded_SS, Restored_Mean, Degraded_Mean, Restored_SD, Degraded_SD)

# Basidiomycota Restored vs Degraded
a_Basidiomycota_degraded <- calculate_resVsdeg(Basidiomycota_deg, Restored_SS, Degraded_SS, Restored_Mean,  Degraded_Mean, Restored_SD, Degraded_SD)

# Basidiomycota Restored vs Reference
a_Basidiomycota_reference <- calculate_resVsref(Basidiomycota_ref, Restored_SS, Degraded_SS, Restored_Mean,  Degraded_Mean, Restored_SD, Degraded_SD)

# Combine all response ratio data
Ascomycota_Basidiomycota_deg_raw <- rbind(a_Ascomycota_degraded, a_Basidiomycota_degraded)
Ascomycota_Basidiomycota_ref_raw <- rbind(a_Ascomycota_reference, a_Basidiomycota_reference)
```

#### Biomass

```{r}
# PLFA content Restored vs Degraded
a_PLFA_degraded <- calculate_resVsdeg(PLFA_degraded, Restored_SS, Degraded_SS, Restored_Mean, Degraded_Mean, Restored_SD, Degraded_SD)

# PLFA content Restored vs Reference
a_PLFA_reference <- calculate_resVsref(PLFA_reference, Restored_SS, Degraded_SS, Restored_Mean, Degraded_Mean,Restored_SD, Degraded_SD)
```

# [Chapter VIII]{style="color: blue;"}

## Publication bias

### Egger's test

#### Alpha diversity

```{r}
# Observed richness Restored vs Degraded
eggers_OTU_deg <- rma(yi = yi, vi = vi, data = a_OTU_resVsdeg, method = "REML")
regtest(eggers_OTU_deg)

# Observed richness Restored vs Reference
eggers_OTU_ref <- rma(yi = yi, vi = vi, data = a_OTU_resVsref, method = "REML")
regtest(eggers_OTU_ref)

# Chao1 richness Restored vs Degraded
eggers_Chao_deg <- rma(yi = yi, vi = vi, data = a_Chao_resVsdeg, method = "REML")
regtest(eggers_Chao_deg)

# Chao1 richness Restored vs Reference
eggers_Chao_ref <- rma(yi = yi, vi = vi, data = a_Chao_resVsref, method = "REML")
regtest(eggers_Chao_ref)

# Shannon index Restored vs Degraded
eggers_Shannon_deg <- rma(yi = yi, vi = vi, data = a_Shannon_resVsdeg, method = "REML")
regtest(eggers_Shannon_deg)

# Shannon index Restored vs Reference
eggers_Shannon_ref <- rma(yi = yi, vi = vi, data = a_Shannon_resVsref, method = "REML")
regtest(eggers_Shannon_ref)

# Simpson index Restored vs Degraded
eggers_Simpson_deg <- rma(yi = yi, vi = vi, data = a_Simpson_resVsdeg, method = "REML")
regtest(eggers_Simpson_deg)

# Simpson index Restored vs Reference
eggers_Simpson_ref <- rma(yi = yi, vi = vi, data = a_Simpson_resVsref, method = "REML")
regtest(eggers_Simpson_ref)
```

#### Composition

```{r}
# Beta diversity Restored vs Degraded
eggers_beta_diversity_degraded <- rma(yi = yi, vi = vi, data = beta_diversity_degraded, method = "REML")
regtest(eggers_beta_diversity_degraded)

# Beta diversity Restored vs Reference
eggers_beta_diversity_reference <- rma(yi = yi, vi = vi, data = beta_diversity_reference, method = "REML")
regtest(eggers_beta_diversity_reference)

# Community structure Restored vs Degraded
eggers_structure_degraded <- rma(yi = yi, vi = vi, data = structure_degraded, method = "REML")
regtest(eggers_structure_degraded)

# Community structure Restored vs Reference
eggers_structure_reference <- rma(yi = yi, vi = vi, data = structure_reference, method = "REML")
regtest(eggers_structure_reference)
```

#### Relative abundance

```{r}
# Ascomycota Restored vs Degraded
eggers_Ascomycota_deg <- rma(yi = yi, vi = vi, data = a_Ascomycota_degraded, method = "REML")
regtest(eggers_Ascomycota_deg)

# Ascomycota Restored vs Reference
eggers_Ascomycota_ref <- rma(yi = yi, vi = vi, data = a_Ascomycota_reference, method = "REML")
regtest(eggers_Ascomycota_ref)

# Basidiomycota Restored vs Degraded
eggers_Basidiomycota_deg <- rma(yi = yi, vi = vi, data = a_Basidiomycota_degraded, method = "REML")
regtest(eggers_Basidiomycota_deg)

# Basidiomycota Restored vs Reference
eggers_Basidiomycota_ref <- rma(yi = yi, vi = vi, data = a_Basidiomycota_reference, method = "REML")
regtest(eggers_Basidiomycota_ref)
```

#### Biomass

```{r}
# PLFA content Restored vs Degraded
eggers_PLFA_deg <- rma(yi = yi, vi = vi, data = a_PLFA_degraded, method = "REML")
regtest(eggers_PLFA_deg)

# PLFA content Restored vs Reference
eggers_PLFA_ref <- rma(yi = yi, vi = vi, data = a_PLFA_reference, method = "REML")
regtest(eggers_PLFA_deg)
```

### Funnel plot

#### Alpha diversity

```{r eval = FALSE}
png("funnel_plot1.tiff", width = 10, height = 6, units = "in", res = 300)

par(mfrow = c(2, 4), mar = c(4.5, 4.5, 4, 2), mgp = c(3, 1, 0))
    
funnel(rma.mv(yi, vi, random = ~ 1 | ID, data = a_OTU_resVsdeg), main = "Observed richness \n(Restored vs Degraded)", 
       xlab = "Effect Size (lnRR)", ylab = "SE", pch = 21, bg = rgb(1, 0.5, 0, alpha = 0.2), 
       col = rgb(0.5, 0.5, 0.5, alpha = 0.2), cex = 1.5, cex.lab = 1.2, cex.axis = 1.1, cex.main = 1.4, font.main = 1, las = 1, 
       back = "white", hlines = "white")

funnel(rma.mv(yi, vi, random = ~ 1 | ID, data = a_OTU_resVsref), main = "Observed richness \n(Restored vs Reference)", 
       xlab = "Effect Size (lnRR)", ylab = NA, pch = 21, bg = rgb(0, 0.805, 0.805, alpha = 0.2), 
       col = rgb(0.5, 0.5, 0.5, alpha = 0.2), cex = 1.5, cex.lab = 1.2, cex.axis = 1.1, cex.main = 1.4, font.main = 1,
       las = 1, back = "white", hlines = "white")

funnel(rma.mv(yi, vi, random = ~ 1 | ID, data = a_Chao_resVsdeg), main = "Chao1 richness \n(Restored vs Degraded)", 
       xlab = "Effect Size (lnRR)", ylab = NA, pch = 21, bg = rgb(1, 0.5, 0, alpha = 0.2), 
       col = rgb(0.5, 0.5, 0.5, alpha = 0.2), cex = 1.5, cex.lab = 1.2, cex.axis = 1.1, cex.main = 1.4, font.main = 1,
       las = 1, back = "white", hlines = "white", mar = c(4.5, 4.5, 4, 2))

funnel(rma.mv(yi, vi, random = ~ 1 | ID, data = a_Chao_resVsref), main = "Chao1 richness \n(Restored vs Reference)", 
       xlab = "Effect Size (lnRR)", ylab = NA, pch = 21, bg = rgb(0, 0.805, 0.805, alpha = 0.2), 
       col = rgb(0.5, 0.5, 0.5, alpha = 0.2), cex = 1.5, cex.lab = 1.2, cex.axis = 1.1, cex.main = 1.4, font.main = 1,
       las = 1, back = "white", hlines = "white")

funnel(rma.mv(yi, vi, random = ~ 1 | ID, data = a_Shannon_resVsdeg), main = "Shannon index \n(Restored vs Degraded)", 
       xlab = "Effect Size (lnRR)", ylab = "SE", pch = 21, bg = rgb(1, 0.5, 0, alpha = 0.2), 
       col = rgb(0.5, 0.5, 0.5, alpha = 0.2), cex = 1.5, cex.lab = 1.2, cex.axis = 1.1, cex.main = 1.4, font.main = 1,
       las = 1, back = "white", hlines = "white", mar = c(4.5, 4.5, 4, 2))

funnel(rma.mv(yi, vi, random = ~ 1 | ID, data = a_Shannon_resVsref), 
       main = "Shannon index \n(Restored vs Reference)", 
       xlab = "Effect Size (lnRR)", ylab = NA,
       pch = 21, bg = rgb(0, 0.805, 0.805, alpha = 0.2), col = rgb(0.5, 0.5, 0.5, alpha = 0.2), cex = 1.5,
       cex.lab = 1.2, cex.axis = 1.1, cex.main = 1.4, font.main = 1,
       las = 1, back = "white", hlines = "white")

funnel(rma.mv(yi, vi, random = ~ 1 | ID, data = a_Simpson_resVsdeg), main = "Simpson index \n(Restored vs Degraded)", 
       xlab = "Effect Size (lnRR)", ylab = NA, pch = 21, bg = rgb(1, 0.5, 0, alpha = 0.2), 
       col = rgb(0.5, 0.5, 0.5, alpha = 0.2), cex = 1.5, cex.lab = 1.2, cex.axis = 1.1, cex.main = 1.4, font.main = 1,
       las = 1, back = "white", hlines = "white")

funnel(rma.mv(yi, vi, random = ~ 1 | ID, data = a_Simpson_resVsref), 
       main = "Simpson index \n(Restored vs Reference)", xlab = "Effect Size (lnRR)", ylab = NA, pch = 21, 
       bg = rgb(0, 0.805, 0.805, alpha = 0.2), col = rgb(0.5, 0.5, 0.5, alpha = 0.2), cex = 1.5, cex.lab = 1.2, 
       cex.axis = 1.1, cex.main = 1.4, font.main = 1, las = 1, back = "white", hlines = "white")

dev.off()
```

#### Relative abundance

```{r eval = FALSE}
png( "funnel_plot2.tiff", width = 10, height = 3, units = "in", res = 300)

par(mfrow = c(1, 4), mar = c(4.5, 4.5, 4, 2), mgp = c(3, 1, 0))

funnel(rma.mv(yi, vi, random = ~ 1 | ID, data = a_Ascomycota_degraded), 
       main = "Ascomycota \n(Restored vs Degraded)", xlab = "Effect Size (lnRR)", ylab = "SE", pch = 21, 
       bg = rgb(1, 0.5, 0, alpha = 0.2), col = rgb(0.5, 0.5, 0.5, alpha = 0.2), cex = 1.5, cex.lab = 1.2, 
       cex.axis = 1.1, cex.main = 1.4, font.main = 1, las = 1, back = "white", hlines = "white")

funnel(rma.mv(yi, vi, random = ~ 1 | ID, data = a_Ascomycota_reference), 
       main = "Ascomycota \n(Restored vs Reference)", xlab = "Effect Size (lnRR)", ylab = NA, pch = 21, 
       bg = rgb(0, 0.805, 0.805, alpha = 0.2), col = rgb(0.5, 0.5, 0.5, alpha = 0.2), cex = 1.5, cex.lab = 1.2,
       cex.axis = 1.1, cex.main = 1.4, font.main = 1, las = 1, back = "white", hlines = "white")

funnel(rma.mv(yi, vi, random = ~ 1 | ID, data = a_Basidiomycota_degraded), 
       main = "Basidiomycota \n(Restored vs Degraded)", xlab = "Effect Size (lnRR)", ylab = NA, pch = 21, 
       bg = rgb(0, 0.805, 0.805, alpha = 0.2), col = rgb(0.5, 0.5, 0.5, alpha = 0.2), cex = 1.5, cex.lab = 1.2,
       cex.axis = 1.1, cex.main = 1.4, font.main = 1, las = 1, back = "white", hlines = "white")

funnel(rma.mv(yi, vi, random = ~ 1 | ID, data = a_Basidiomycota_reference), 
       main = "Basidiomycota \n(Restored vs Reference)", xlab = "Effect Size (lnRR)", ylab = NA, pch = 21, 
       bg = rgb(0, 0.805, 0.805, alpha = 0.2), col = rgb(0.5, 0.5, 0.5, alpha = 0.2), cex = 1.5, cex.lab = 1.2, 
       cex.axis = 1.1, cex.main = 1.4, font.main = 1, las = 1, back = "white", hlines = "white")
dev.off()
```

#### Composition

```{r eval = FALSE}
png("funnel_plot3.tiff", width = 10, height = 3, units = "in", res = 300)

par(mfrow = c(1, 4), mar = c(4.5, 4.5, 4, 2), mgp = c(3, 1, 0))

funnel(rma.mv(yi, vi, random = ~ 1 | ID, data = beta_diversity_degraded), 
       main = "Beta diversity \n(Restored vs Degraded)", xlab = "Effect Size (lnRR)", ylab = "SE",
       pch = 21, bg = rgb(1, 0.5, 0, alpha = 0.2), col = rgb(0.5, 0.5, 0.5, alpha = 0.2), cex = 1.5, 
       cex.lab = 1.2, cex.axis = 1.1, cex.main = 1.4, font.main = 1, las = 1, back = "white", hlines = "white")

funnel(rma.mv(yi, vi, random = ~ 1 | ID, data = beta_diversity_reference), 
       main = "Beta diversity \n(Restored vs Reference)", xlab = "Effect Size (lnRR)", ylab = NA,
       pch = 21, bg = rgb(0, 0.805, 0.805, alpha = 0.2), col = rgb(0.5, 0.5, 0.5, alpha = 0.2), cex = 1.5,
       cex.lab = 1.2, cex.axis = 1.1, cex.main = 1.4, font.main = 1,las = 1, back = "white", hlines = "white")

funnel(rma.mv(yi, vi, random = ~ 1 | ID, data = structure_degraded), 
       main = "Structure \n(Restored vs Degraded)", xlab = "Effect Size (lnRR)", ylab = NA,
       pch = 21, bg = rgb(1, 0.5, 0, alpha = 0.2), col = rgb(0.5, 0.5, 0.5, alpha = 0.2), cex = 1.5,
       cex.lab = 1.2, cex.axis = 1.1, cex.main = 1.4, font.main = 1, las = 1, back = "white", hlines = "white")

funnel(rma.mv(yi, vi, random = ~ 1 | ID, data = structure_reference), 
       main = "Structure \n(Restored vs Reference)", xlab = "Effect Size (lnRR)", ylab = NA,
       pch = 21, bg = rgb(0, 0.805, 0.805, alpha = 0.2), col = rgb(0.5, 0.5, 0.5, alpha = 0.2), cex = 1.5,
       cex.lab = 1.2, cex.axis = 1.1, cex.main = 1.4, font.main = 1, las = 1, back = "white", hlines = "white")

dev.off()
```

```{r eval = FALSE}
png("funnel_plot4.tiff", width = 10, height = 3, units = "in", res = 300)

# Set larger margins for multi-plot layout
par(mfrow = c(1, 4), mar = c(4.5, 4.5, 4, 2), mgp = c(3, 1, 0))
funnel(rma.mv(yi, vi, random = ~ 1 | ID, data = a_PLFA_degraded), main = "PLFA content\n(Restored vs Degraded)", 
       xlab = "Effect Size (lnRR)", ylab = "SE", pch = 21, bg = rgb(0, 0.805, 0.805, alpha = 0.2), 
       col = rgb(0.5, 0.5, 0.5, alpha = 0.2), cex = 1.5, cex.lab = 1.2, cex.axis = 1.1, cex.main = 1.4, font.main = 1, 
       las = 1, back = "white", hlines = "white")

funnel(rma.mv(yi, vi, random = ~ 1 | ID, data = a_PLFA_reference), main = "PLFA content\n(Restored vs Reference)", 
       xlab = "Effect Size (lnRR)", ylab = "SE", pch = 21, bg = rgb(0, 0.805, 0.805, alpha = 0.2), 
       col = rgb(0.5, 0.5, 0.5, 1.5, cex.lab = 1.2, cex.axis = 1.1, cex.main = 1.4, font.main = 1, 
                 las = 1, back = "white", hlines = "white")

dev.off()
```

# [Chapter IX]{style="color: blue;"}

## Overall effect of vegetation restoration

### Alpha diversity

```{r}
# Observed richness Restored vs Degraded
OTU_deg = rma.mv(yi, vi, random = ~ 1 | ID, data = a_OTU_resVsdeg)
OTU_deg

# Observed richness Restored vs Reference
OTU_ref = rma.mv(yi, vi, random = ~ 1 | ID, data = a_OTU_resVsref)
OTU_ref

# Chao1 richness Restored vs Degraded
Chao_deg = rma.mv(yi, vi, random = ~ 1 | ID, data = a_Chao_resVsdeg)
Chao_deg

# Chao1 richness Restored vs Reference
Chao_ref = rma.mv(yi, vi, random = ~ 1 | ID, data = a_Chao_resVsref)
Chao_ref

# Shannon index Restored vs Degraded
Shannon_deg = rma.mv(yi, vi, random = ~ 1 | ID, data = a_Shannon_resVsdeg)
Shannon_deg

# Shannon index Restored vs Reference
Shannon_ref = rma.mv(yi, vi, random = ~ 1 | ID, data = a_Shannon_resVsref)
Shannon_ref

# Simpson index Restored vs Degraded
Simpson_deg = rma.mv(yi, vi, random = ~ 1 | ID, data = a_Simpson_resVsdeg)
Simpson_deg

# Shannon index Restored vs Reference
Simpson_ref = rma.mv(yi, vi, random = ~ 1 | ID, data = a_Simpson_resVsref)
Simpson_ref

# prepare dataset for number of studies and number of observations
OTU_counts_deg <- a_OTU_resVsdeg %>%group_by(Metrics) %>%summarise(studies = n_distinct(ID), observations = n())
OTU_counts_ref <- a_OTU_resVsref %>%group_by(Metrics) %>% summarise(studies = n_distinct(ID), observations = n())
Chao_counts_deg <- a_Chao_resVsdeg %>%group_by(Metrics) %>%summarise( studies = n_distinct(ID), observations = n())
Chao_counts_ref <- a_Chao_resVsref %>%group_by(Metrics) %>% summarise(studies = n_distinct(ID), observations = n())
Shannon_counts_deg <- a_Shannon_resVsdeg %>%group_by(Metrics) %>%summarise(studies = n_distinct(ID), observations = n())
Shannon_counts_ref <- a_Shannon_resVsref %>%group_by(Metrics) %>% summarise( studies = n_distinct(ID), observations = n())
Simpson_counts_deg <- a_Simpson_resVsdeg %>%group_by(Metrics) %>%summarise(studies = n_distinct(ID), observations = n())
Simpson_counts_ref <- a_Simpson_resVsref %>%group_by(Metrics) %>% summarise(studies = n_distinct(ID), observations = n())

alpha_diversity_counts <- bind_rows(OTU_counts_deg %>% mutate(Comparison = "Restored vs Degraded", Metrics = "Observed richness"), OTU_counts_ref %>% mutate(Comparison = "Restored vs Reference", Metrics = "Observed richness"), Chao_counts_deg %>% mutate(Comparison = "Restored vs Degraded", Metrics = "Chao1 richness"), Chao_counts_ref %>% mutate(Comparison = "Restored vs Reference", Metrics = "Chao1 richness"), Shannon_counts_deg %>% mutate(Comparison = "Restored vs Degraded", Metrics = "Shannon index"), Shannon_counts_ref %>% mutate(Comparison = "Restored vs Reference", Metrics = "Shannon index"), Simpson_counts_deg %>% mutate(Comparison = "Restored vs Degraded", Metrics = "Simpson index"), Simpson_counts_ref %>% mutate(Comparison = "Restored vs Reference", Metrics = "Simpson index"))

# Observed richness change to % Change
OTU_mean_ci <- data.frame(Comparison = c("Restored vs Degraded", "Restored vs Reference"), Metrics = "Observed richness", yi = c(coef(OTU_deg)[1], coef(OTU_ref)[1]), ci.lb = c(OTU_deg$ci.lb[1], OTU_ref$ci.lb[1]), ci.ub = c(OTU_deg$ci.ub[1], OTU_ref$ci.ub[1])) %>% mutate(yi_pct = (exp(yi) - 1) * 100, ci.lb_pct = (exp(ci.lb) - 1) * 100, ci.ub_pct = (exp(ci.ub) - 1) * 100)

# Chao1 richness change to % Change
Chao_mean_ci <- data.frame(Comparison = c("Restored vs Degraded", "Restored vs Reference"), Metrics = "Chao1 richness", yi = c(coef(Chao_deg)[1], coef(Chao_ref)[1]), ci.lb = c(Chao_deg$ci.lb[1], Chao_ref$ci.lb[1]), ci.ub = c(Chao_deg$ci.ub[1], Chao_ref$ci.ub[1])) %>% mutate(yi_pct = (exp(yi) - 1) * 100, ci.lb_pct = (exp(ci.lb) - 1) * 100, ci.ub_pct = (exp(ci.ub) - 1) * 100)

# Shannon index change to % Change
Shannon_mean_ci <- data.frame(Comparison = c("Restored vs Degraded", "Restored vs Reference"), Metrics = "Shannon index", yi = c(coef(Shannon_deg)[1], coef(Shannon_ref)[1]), ci.lb = c(Shannon_deg$ci.lb[1], Shannon_ref$ci.lb[1]), ci.ub = c(Shannon_deg$ci.ub[1], Shannon_ref$ci.ub[1])) %>% mutate(yi_pct = (exp(yi) - 1) * 100, ci.lb_pct = (exp(ci.lb) - 1) * 100, ci.ub_pct = (exp(ci.ub) - 1) * 100)

# Simpson index change to % Change
Simpson_mean_ci <- data.frame(Comparison = c("Restored vs Degraded", "Restored vs Reference"), Metrics = "Simpson index", yi = c(coef(Simpson_deg)[1], coef(Simpson_ref)[1]), ci.lb = c(Simpson_deg$ci.lb[1], Simpson_ref$ci.lb[1]), ci.ub = c(Simpson_deg$ci.ub[1], Simpson_ref$ci.ub[1])) %>% mutate(yi_pct = (exp(yi) - 1) * 100, ci.lb_pct = (exp(ci.lb) - 1) * 100, ci.ub_pct = (exp(ci.ub) - 1) * 100)

# Combine all mean and CI
alpha_diversity_mean_ci <- rbind (OTU_mean_ci, Chao_mean_ci, Shannon_mean_ci, Simpson_mean_ci)

alpha_diversity_mean_ci <- alpha_diversity_mean_ci %>%left_join(alpha_diversity_counts, by = c("Comparison", "Metrics")) %>%mutate(annotation = paste0("(", studies, "|", observations, ")"))

alpha_diversity_mean_ci <- alpha_diversity_mean_ci %>% mutate(Parameter = "Alpha diversity") 
```

```{r}
# Get common column names across ALL datasets
all_datasets <- list(a_OTU_resVsdeg, a_OTU_resVsref, a_Chao_resVsdeg, a_Chao_resVsref, a_Shannon_resVsdeg, a_Shannon_resVsref, a_Simpson_resVsdeg, a_Simpson_resVsref)

# Find columns that are common to ALL datasets
common_cols <- Reduce(intersect, lapply(all_datasets, names))

# Combine ALL datasets with only common columns (use existing Comparison and Metrics)
combined_data <- bind_rows(a_OTU_resVsdeg %>% select(all_of(common_cols)), a_OTU_resVsref %>% select(all_of(common_cols)), a_Chao_resVsdeg %>% select(all_of(common_cols)), a_Chao_resVsref %>% select(all_of(common_cols)), a_Shannon_resVsdeg %>% select(all_of(common_cols)), a_Shannon_resVsref %>% select(all_of(common_cols)), a_Simpson_resVsdeg %>% select(all_of(common_cols)), a_Simpson_resVsref %>% select(all_of(common_cols)))

# Convert raw yi (log scale) to percentage scale
combined_data <- combined_data %>% mutate(yi_pct = (exp(yi) - 1) * 100)

# Remove extreme data
rows_to_remove <- c(984, 991, 1073, 987, 312, 314, 146, 147, 285, 284, 269, 274, 8)
combined_data_filtered <- combined_data[-rows_to_remove, ]
```

```{r}
# Plots
combined_data_filtered$Metrics <- factor(combined_data_filtered$Metrics, levels = c("Simpson index", "Shannon index", "Chao1 richness", "Observed richness"))

alpha_diversity_mean_ci$Metrics <- factor(alpha_diversity_mean_ci$Metrics, levels = c("Simpson index", "Shannon index", "Chao1 richness", "Observed richness"))

# Plot for Restored vs Degraded
alpha_diversity_deg_plot <- ggplot() + geom_vline(xintercept = 0, linetype = "dashed", color = "grey60") + geom_point(data = combined_data_filtered %>% filter(Comparison == "Restored vs Degraded"), aes(x = yi_pct, y = Metrics), position = position_jitter(height = 0.15, width = 0), alpha = 0.2, size = 3, shape = 21, fill = "orange", stroke = 0.1) + geom_pointrange(data = alpha_diversity_mean_ci %>% filter(Comparison == "Restored vs Degraded"), aes(x = yi_pct, y = Metrics, xmin = ci.lb_pct, xmax = ci.ub_pct), size = 0.5, shape = 1, linewidth = 0.5, fill = "black", stroke = 0.5, position = position_nudge(y = -0.005)) + labs(x = "% Change (Alpha diversity)", y = NULL) + theme_bw() + theme(legend.position = "none", axis.ticks.y = element_blank(), axis.text.y = element_blank(), plot.title = element_text(hjust = 0.5, face = "plain", size = 14), axis.title = element_text(face = "plain", size = 12), axis.text = element_text(size = 10, color = "black"), panel.grid.major = element_line(color = "transparent"), panel.grid.minor = element_blank(), panel.border = element_rect(color = "black", fill = NA))

# Plot for Restored vs Reference
alpha_diversity_ref_plot <- ggplot() + geom_vline(xintercept = 0, linetype = "dashed", color = "grey60") + geom_point(data = combined_data_filtered %>% filter(Comparison == "Restored vs Reference"), aes(x = yi_pct, y = Metrics), position = position_jitter(height = 0.15, width = 0), alpha = 0.2, size = 3, shape = 21, fill = "cyan3", stroke = 0.1) + geom_pointrange(data = alpha_diversity_mean_ci %>% filter(Comparison == "Restored vs Reference"), aes(x = yi_pct, y = Metrics, xmin = ci.lb_pct, xmax = ci.ub_pct), size = 0.5, shape = 1, linewidth = 0.5, fill = "black", stroke = 0.5, position = position_nudge(y = -0.005)) + labs(x = "% Change (Alpha diversity)", y = NULL) + theme_bw() + theme(legend.position = "none", axis.ticks.y = element_blank(), axis.text.y = element_blank(), plot.title = element_text(hjust = 0.5, face = "plain", size = 14), axis.title = element_text(face = "plain", size = 12), axis.text = element_text(size = 10, color = "black"), panel.grid.major = element_line(color = "transparent"), panel.grid.minor = element_blank(), panel.border = element_rect(color = "black", fill = NA))

# Combine them
alpha_diversity_combined_plot <- grid.arrange(alpha_diversity_deg_plot, alpha_diversity_ref_plot, ncol = 2)
```

### Composition

```{r}
# Beta diversity Restored vs Degraded
mod_beta_diversity_degraded <- rma.mv(yi, vi, random = ~ 1 | ID, data = beta_diversity_degraded)
mod_beta_diversity_degraded

# Beta diversity Restored vs Reference
mod_beta_diversity_reference <- rma.mv(yi, vi, random = ~ 1 | ID, data = beta_diversity_reference)
mod_beta_diversity_reference

# Community structure Restored vs Degraded
mod_structure_degraded <- rma.mv(yi, vi, random = ~ 1 | ID, data = structure_degraded)
mod_structure_degraded

# Community structure Restored vs Reference
mod_structure_reference <- rma.mv(yi, vi, random = ~ 1 | ID, data = structure_reference)
mod_structure_reference

# Beta diversity change to % Change
beta_diversity_mean_ci <- data.frame(Comparison = c("Restored vs Degraded", "Restored vs Reference"), Metrics = "Beta diversity", yi = c(coef(mod_beta_diversity_degraded)[1], coef(mod_beta_diversity_reference)[1]), ci.lb = c(mod_beta_diversity_degraded$ci.lb[1], mod_beta_diversity_reference$ci.lb[1]), ci.ub = c(mod_beta_diversity_degraded$ci.ub[1], mod_beta_diversity_reference$ci.ub[1])) %>% mutate(yi_pct = (exp(yi) - 1) * 100, ci.lb_pct = (exp(ci.lb) - 1) * 100, ci.ub_pct = (exp(ci.ub) - 1) * 100)

# Community structure change to % Change
structure_diversity_mean_ci <- data.frame(Comparison = c("Restored vs Degraded", "Restored vs Reference"), Metrics = "Community structure", yi = c(coef(mod_structure_degraded)[1], coef(mod_structure_reference)[1]), ci.lb = c(mod_structure_degraded$ci.lb[1], mod_structure_reference$ci.lb[1]), ci.ub = c(mod_structure_degraded$ci.ub[1], mod_structure_reference$ci.ub[1])) %>% mutate(yi_pct = (exp(yi) - 1) * 100, ci.lb_pct = (exp(ci.lb) - 1) * 100, ci.ub_pct = (exp(ci.ub) - 1) * 100)

# Combine mean and CI
beta_diversity_Beta_compo <- rbind(beta_diversity_mean_ci, structure_diversity_mean_ci)
                            
counts_beta_diversity_degraded <- beta_diversity_degraded %>%  group_by(Metrics) %>% summarise( studies = n_distinct(ID), observations = n())
                                     
counts_beta_diversity_reference <- beta_diversity_reference %>%group_by(Metrics) %>% summarise(studies = n_distinct(ID), observations = n())
                                     
counts_structure_degraded <- beta_diversity_degraded %>% group_by(Metrics) %>% summarise(studies = n_distinct(ID), observations = n())
                                     
counts_structure_reference <- beta_diversity_reference %>%group_by(Metrics) %>% summarise(studies = n_distinct(ID), observations = n())
                                     
all_counts <- bind_rows(counts_beta_diversity_degraded %>% mutate(Comparison = "Restored vs Degraded",Metrics = "Beta diversity"),counts_beta_diversity_reference %>% mutate(Comparison = "Restored vs Reference",Metrics = "Beta diversity"), counts_structure_degraded %>% mutate(Comparison = "Restored vs Degraded", Metrics = "Structure"), counts_structure_reference %>% mutate(Comparison = "Restored vs Reference",Metrics = "Community structure"))
                                     
beta_diversity_Beta_compo <- beta_diversity_Beta_compo %>%left_join(all_counts, by = c("Comparison", "Metrics")) %>% mutate(annotation = paste0("(", studies, "|", observations, ")"))

beta_diversity_Beta_compo <- beta_diversity_Beta_compo %>% mutate(Parameter = "Community structure") 
```

```{r}
composition_raw_degraded <- bind_rows(beta_diversity_degraded, structure_degraded)
composition_raw_reference <- bind_rows(beta_diversity_reference, structure_reference)

# Get common column names between the two datasets
common_cols_composition <- intersect(names(composition_raw_degraded), names(composition_raw_reference))

# Combine with only common columns
composition_raw_combined <- bind_rows(composition_raw_degraded %>% select(all_of(common_cols_composition)), composition_raw_reference %>% select(all_of(common_cols_composition)))

# Convert raw yi (log scale) to percentage scale
composition_raw_combined <- composition_raw_combined %>% mutate(yi_pct = (exp(yi) - 1) * 100)

composition_raw_combined <- composition_raw_combined %>%filter(yi_pct <= 400)

composition_raw_combined <- composition_raw_combined %>%mutate(Metrics = recode(Metrics, "Structure" = "Community structure"))

composition_raw_combined$Metrics <- factor(composition_raw_combined$Metrics,levels = c("Community structure", "Beta diversity"))
beta_diversity_Beta_compo$Metrics <- factor (beta_diversity_Beta_compo$Metrics,levels = c("Community structure","Beta diversity"))

# Plot for Restored vs Degraded
beta_diversity_deg_plot <- ggplot() + geom_vline(xintercept = 0, linetype = "dashed", color = "grey60") + geom_point(data = composition_raw_combined %>% filter(Comparison == "Restored vs Degraded"), aes(x = yi_pct, y = Metrics), position = position_jitter(height = 0.15, width = 0), alpha = 0.2, size = 3, shape = 21, fill = "orange", stroke = 0.1) + geom_pointrange(data = beta_diversity_Beta_compo %>% filter(Comparison == "Restored vs Degraded"), aes(x = yi_pct, y = Metrics, xmin = ci.lb_pct, xmax = ci.ub_pct), size = 0.5, shape = 1, linewidth = 0.5, fill = "black", stroke = 0.5, position = position_nudge(y = -0.005)) + labs(x = "% Change (Composition)", y = NULL) + theme_bw() + theme(legend.position = "none", axis.ticks.y = element_blank(), axis.text.y = element_blank(), plot.title = element_text(hjust = 0.5, face = "plain", size = 14), axis.title = element_text(face = "plain", size = 12), axis.text = element_text(size = 10, color = "black"), panel.grid.major = element_line(color = "transparent"), panel.grid.minor = element_blank(), panel.border = element_rect(color = "black", fill = NA))

# Plot for Restored vs Reference
beta_diversity_ref_plot <- ggplot() + geom_vline(xintercept = 0, linetype = "dashed", color = "grey60") + geom_point(data = composition_raw_combined %>% filter(Comparison == "Restored vs Reference"), aes(x = yi_pct, y = Metrics), position = position_jitter(height = 0.15, width = 0), alpha = 0.2, size = 3, shape = 21, fill = "cyan3", stroke = 0.1) + geom_pointrange(data = beta_diversity_Beta_compo %>% filter(Comparison == "Restored vs Reference"), aes(x = yi_pct, y = Metrics, xmin = ci.lb_pct, xmax = ci.ub_pct), size = 0.5, shape = 1, linewidth = 0.5, fill = "black", stroke = 0.5, position = position_nudge(y = -0.005)) + labs(x = "% Change (Composition)", y = NULL) + theme_bw() + theme(legend.position = "none", axis.ticks.y = element_blank(), axis.text.y = element_blank(), plot.title = element_text(hjust = 0.5, face = "plain", size = 14), axis.title = element_text(face = "plain", size = 12), axis.text = element_text(size = 10, color = "black"), panel.grid.major = element_line(color = "transparent"), panel.grid.minor = element_blank(), panel.border = element_rect(color = "black", fill = NA))

# Combine them
beta_diversity_combined_plot <- grid.arrange(beta_diversity_deg_plot, beta_diversity_ref_plot, ncol = 2)
```

### Relative abundance

```{r}
# Ascomycota Restored vs Degraded
mod_Ascomycota_degraded <- rma.mv(yi, vi, random = ~ 1 | ID, data = a_Ascomycota_degraded)
mod_Ascomycota_degraded

# Ascomycota Restored vs Reference
mod_Ascomycota_reference <- rma.mv(yi, vi, random = ~ 1 | ID, data = a_Ascomycota_reference)
mod_Ascomycota_reference

# Basidiomycota Restored vs Degraded
mod_Basidiomycota_degraded <- rma.mv(yi, vi, random = ~ 1 | ID, data = a_Basidiomycota_degraded)
mod_Basidiomycota_degraded

# Basidiomycota Restored vs Reference
mod_Basidiomycota_reference <- rma.mv(yi, vi, random = ~ 1 | ID, data = a_Basidiomycota_reference)
mod_Basidiomycota_reference

# Ascomycota change to % Change
Ascomycota_mean_ci <- data.frame(Comparison = c("Restored vs Degraded", "Restored vs Reference"), Metrics = "Ascomycota", yi = c(coef(mod_Ascomycota_degraded)[1], coef(mod_Ascomycota_reference)[1]), ci.lb = c(mod_Ascomycota_degraded$ci.lb[1], mod_Ascomycota_reference$ci.lb[1]), ci.ub = c(mod_Ascomycota_degraded$ci.ub[1], mod_Ascomycota_reference$ci.ub[1])) %>% mutate(yi_pct = (exp(yi) - 1) * 100, ci.lb_pct = (exp(ci.lb) - 1) * 100, ci.ub_pct = (exp(ci.ub) - 1) * 100)

# Basidiomycota change to % Change
Basidiomycota_mean_ci <- data.frame(Comparison = c("Restored vs Degraded", "Restored vs Reference"), Metrics = "Basidiomycota", yi = c(coef(mod_Basidiomycota_degraded)[1], coef(mod_Basidiomycota_reference)[1]), ci.lb = c(mod_Basidiomycota_degraded$ci.lb[1], mod_Basidiomycota_reference$ci.lb[1]), ci.ub = c(mod_Basidiomycota_degraded$ci.ub[1], mod_Basidiomycota_reference$ci.ub[1])) %>% mutate(yi_pct = (exp(yi) - 1) * 100, ci.lb_pct = (exp(ci.lb) - 1) * 100, ci.ub_pct = (exp(ci.ub) - 1) * 100)

# Combine mean and CI
Ascomycota_Basidiomycota <- rbind(Ascomycota_mean_ci, Basidiomycota_mean_ci)

counts_Ascomycota_degraded <- a_Ascomycota_degraded %>% group_by(Metrics) %>% summarise(studies = n_distinct(ID), observations = n())

counts_Ascomycota_reference <- a_Ascomycota_reference %>% group_by(Metrics) %>% summarise(studies = n_distinct(ID), observations = n())

counts_Basidiomycota_degraded <- a_Basidiomycota_degraded %>% group_by(Metrics) %>% summarise(studies = n_distinct(ID), observations = n())

counts_Basidiomycota_reference <- a_Basidiomycota_reference %>% group_by(Metrics) %>% summarise( studies = n_distinct(ID), observations = n())

all_counts <- bind_rows(counts_Ascomycota_degraded %>% mutate(Comparison = "Restored vs Degraded", Metrics = "Ascomycota"),counts_Ascomycota_reference %>% mutate(Comparison = "Restored vs Reference", Metrics = "Ascomycota"), counts_Basidiomycota_degraded %>% mutate(Comparison = "Restored vs Degraded", Metrics = "Basidiomycota"), counts_Basidiomycota_reference %>% mutate(Comparison = "Restored vs Reference", Metrics = "Basidiomycota"))

Ascomycota_Basidiomycota_combined <- Ascomycota_Basidiomycota %>%left_join(all_counts, by = c("Comparison", "Metrics")) %>% mutate(annotation = paste0("(", studies, "|", observations, ")"))

Ascomycota_Basidiomycota_combined <- Ascomycota_Basidiomycota_combined %>% mutate(Parameter = "Relative abundance") 
```

```{r}
# Get common column names between the two datasets
common_cols_abundance <- intersect(names(Ascomycota_Basidiomycota_deg_raw), names(Ascomycota_Basidiomycota_ref_raw))

# Combine with only common columns
abundance_raw_combined <- bind_rows(Ascomycota_Basidiomycota_deg_raw %>% select(all_of(common_cols_abundance)), Ascomycota_Basidiomycota_ref_raw %>% select(all_of(common_cols_abundance)))

# Convert raw yi (log scale) to percentage scale
abundance_raw_combined <- abundance_raw_combined %>%mutate(yi_pct = (exp(yi) - 1) * 100)

abundance_raw_combined <- abundance_raw_combined %>%filter(yi_pct <= 500)

abundance_raw_combined$Metrics <- factor (abundance_raw_combined$Metrics, levels = c("Basidiomycota","Ascomycota"))

Ascomycota_Basidiomycota_combined$Metrics <- factor (Ascomycota_Basidiomycota_combined$Metrics, levels = c("Basidiomycota", "Ascomycota"))

# Plot for Restored vs Degraded
abundance_deg_plot <- ggplot() + geom_vline(xintercept = 0, linetype = "dashed", color = "grey60") + geom_point(data = abundance_raw_combined %>% filter(Comparison == "Restored vs Degraded"), aes(x = yi_pct, y = Metrics), position = position_jitter(height = 0.15, width = 0), alpha = 0.2, size = 3, shape = 21, fill = "orange", stroke = 0.1) + geom_pointrange(data = Ascomycota_Basidiomycota_combined %>% filter(Comparison == "Restored vs Degraded"), aes(x = yi_pct, y = Metrics, xmin = ci.lb_pct, xmax = ci.ub_pct), size = 0.5, shape = 1, linewidth = 0.5, fill = "black", stroke = 0.5, position = position_nudge(y = -0.005)) + labs(x = "% Change (Relative abundance)", y = NULL) + theme_bw() + theme(legend.position = "none", axis.ticks.y = element_blank(), axis.text.y = element_blank(), plot.title = element_text(hjust = 0.5, face = "plain", size = 14), axis.title = element_text(face = "plain", size = 12), axis.text = element_text(size = 10, color = "black"), panel.grid.major = element_line(color = "transparent"), panel.grid.minor = element_blank(), panel.border = element_rect(color = "black", fill = NA))

abundance_ref_plot <- ggplot() + geom_vline(xintercept = 0, linetype = "dashed", color = "grey60") + geom_point(data = abundance_raw_combined %>% filter(Comparison == "Restored vs Reference"), aes(x = yi_pct, y = Metrics), position = position_jitter(height = 0.15, width = 0), alpha = 0.2, size = 3, shape = 21, fill = "cyan3", stroke = 0.1) + geom_pointrange(data = Ascomycota_Basidiomycota_combined %>% filter(Comparison == "Restored vs Reference"), aes(x = yi_pct, y = Metrics, xmin = ci.lb_pct, xmax = ci.ub_pct), size = 0.5, shape = 1, linewidth = 0.5, fill = "black", stroke = 0.5, position = position_nudge(y = -0.005)) + labs(x = "% Change (Relative abundance)", y = NULL) + theme_bw() + theme(legend.position = "none", axis.ticks.y = element_blank(), axis.text.y = element_blank(), plot.title = element_text(hjust = 0.5, face = "plain", size = 14), axis.title = element_text(face = "plain", size = 12), axis.text = element_text(size = 10, color = "black"), panel.grid.major = element_line(color = "transparent"), panel.grid.minor = element_blank(), panel.border = element_rect(color = "black", fill = NA))

# Combine them
abundance_combined_plot <- grid.arrange(abundance_deg_plot, abundance_ref_plot, ncol = 2)
```

### Biomass

```{r}
# PLFA content Restored vs Degraded
mod_PLFA_degraded  <- rma.mv(yi, vi, random = ~1 | ID, control = list(optimizer = "optim"), data = a_PLFA_degraded)

# PLFA content Restored vs Reference
mod_PLFA_reference <- rma.mv(yi, vi, random = ~1 | ID, control = list(optimizer = "optim"), data = a_PLFA_reference)

# PLFA content change to % Change
PLFA_mean_ci <- tibble(Comparison = c("Restored vs Degraded", "Restored vs Reference"), Metrics = "PLFA content", yi = c(coef(mod_PLFA_degraded)[1], coef(mod_PLFA_reference)[1]), ci.lb = c(mod_PLFA_degraded$ci.lb[1], mod_PLFA_reference$ci.lb[1]), ci.ub = c(mod_PLFA_degraded$ci.ub[1], mod_PLFA_reference$ci.ub[1])) %>% mutate(yi_pct = (exp(yi) - 1) * 100, ci.lb_pct = (exp(ci.lb) - 1) * 100, ci.ub_pct = (exp(ci.ub) - 1) * 100)

## Study and observation counts
count_fun <- function(dat) {dat %>% summarise(studies = n_distinct(ID), observations = n(), .groups = "drop" )}

all_counts <- bind_rows(count_fun(a_PLFA_degraded)  %>% mutate(Comparison = "Restored vs Degraded"), count_fun(a_PLFA_reference) %>% mutate(Comparison = "Restored vs Reference")) %>% mutate(Metrics = "PLFA content")

# Combine results with counts
PLFA_mean_ci_combined <- PLFA_mean_ci %>% left_join(all_counts, by = c("Comparison", "Metrics")) %>% mutate(annotation = paste0("(", studies, "|", observations, ")"), Parameter  = "Biomass")
```

```{r}
# Get common column names between the two datasets
common_cols_plfa <- intersect(names(a_PLFA_degraded), names(a_PLFA_reference))

# Combine with only common columns
plfa_raw_combined <- bind_rows(a_PLFA_degraded %>% select(all_of(common_cols_plfa)), a_PLFA_reference %>% select(all_of(common_cols_plfa)))

# Convert raw yi (log scale) to percentage scale
plfa_raw_combined <- plfa_raw_combined %>% mutate(yi_pct = (exp(yi) - 1) * 100)

plfa_raw_combined <- plfa_raw_combined %>% filter(yi_pct <= 500)

# Plot
plfa_deg_plot <- ggplot() + geom_vline(xintercept = 0, linetype = "dashed", color = "grey60") + geom_point(data = plfa_raw_combined %>% filter(Comparison == "Restored vs Degraded"), aes(x = yi_pct, y = Metrics), position = position_jitter(height = 0.15, width = 0), alpha = 0.2, size = 3, shape = 21, fill = "orange", stroke = 0.1) + geom_pointrange(data = PLFA_mean_ci_combined %>% filter(Comparison == "Restored vs Degraded"), aes(x = yi_pct, y = Metrics, xmin = ci.lb_pct, xmax = ci.ub_pct), size = 0.5, shape = 1, linewidth = 0.5, fill = "black", stroke = 0.5, position = position_nudge(y = -0.005)) + labs(x = "% Change (Biomass)", y = NULL) + theme_bw() + theme(legend.position = "none", axis.ticks.y = element_blank(), axis.text.y = element_blank(), plot.title = element_text(hjust = 0.5, face = "plain", size = 14), axis.title = element_text(face = "plain", size = 12), axis.text = element_text(size = 10, color = "black"), panel.grid.major = element_line(color = "transparent"), panel.grid.minor = element_blank(), panel.border = element_rect(color = "black", fill = NA))

plfa_ref_plot <- ggplot() + geom_vline(xintercept = 0, linetype = "dashed", color = "grey60") + geom_point(data = plfa_raw_combined %>% filter(Comparison == "Restored vs Reference"), aes(x = yi_pct, y = Metrics), position = position_jitter(height = 0.15, width = 0), alpha = 0.2, size = 3, shape = 21, fill = "cyan3", stroke = 0.1) + geom_pointrange(data = PLFA_mean_ci_combined %>% filter(Comparison == "Restored vs Reference"), aes(x = yi_pct, y = Metrics, xmin = ci.lb_pct, xmax = ci.ub_pct), size = 0.5, shape = 1, linewidth = 0.5, fill = "black", stroke = 0.5, position = position_nudge(y = -0.005)) + labs(x = "% Change (Biomass)", y = NULL) + theme_bw() + theme(legend.position = "none", axis.ticks.y = element_blank(), axis.text.y = element_blank(), plot.title = element_text(hjust = 0.5, face = "plain", size = 14), axis.title = element_text(face = "plain", size = 12), axis.text = element_text(size = 10, color = "black"), panel.grid.major = element_line(color = "transparent"), panel.grid.minor = element_blank(), panel.border = element_rect(color = "black", fill = NA))

# Arrange them side by side
plfa_combined_plot <- grid.arrange(plfa_deg_plot, plfa_ref_plot, ncol = 2)
```

### Figure 2

```{r}
Figure_2_deg1 <- grid.arrange(alpha_diversity_deg_plot, plfa_deg_plot, nrow = 2, heights = c(1, 0.4))
Figure_2_deg2 <- grid.arrange(abundance_deg_plot, beta_diversity_deg_plot, nrow = 2, heights = c(1, 1))
Figure_2_ref4 <- grid.arrange(alpha_diversity_ref_plot, plfa_ref_plot, nrow = 2, heights = c(1, 0.4))
Figure_2_ref5 <- grid.arrange(abundance_ref_plot, beta_diversity_ref_plot, nrow = 2, heights = c(1, 1))
```

```{r}
Figure_2_deg3 <- grid.arrange(Figure_2_deg1, Figure_2_deg2, ncol = 2, widths = c(1, 1), top  = textGrob("Restored vs Degraded", gp = gpar(fontsize = 12, fontface = "bold")))
Figure_2_deg3
Figure_2_ref6 <- grid.arrange(Figure_2_ref4, Figure_2_ref5, ncol = 2, widths = c(1, 1), top = textGrob("Restored vs Reference", gp = gpar(fontsize = 12, fontface = "bold")))
Figure_2_ref6
```

```{r eval = FALSE}
ggsave("figure_2.1.jpg", combined_plot_deg3, dpi = 600, height = 5, width = 5)
ggsave("figure_2.2.jpg", combined_plot_ref6, dpi = 600, height = 5, width = 5)
```

# [Chapte X]{style="color: blue;"}

## Effect of restoration strategy

#### Function to calculate predicted value

```{r}
get_predictions <- function(model, data, comparison_type, metric_type) {
   pred_grid <- data.frame(Restoration_strategy = levels(data$Restoration_strategy))
   predictions <- predict(model, newmods = model.matrix(~ Restoration_strategy, data = pred_grid)[,-1, drop = FALSE])
    study_counts <- data %>%
    group_by(Restoration_strategy) %>%
    summarize(n_studies = n_distinct(ID), n_observations = n())
    results <- data.frame(
    Restoration_strategy = pred_grid$Restoration_strategy,
    pred = predictions$pred,
    se = predictions$se,
    ci.lb = predictions$ci.lb,
    ci.ub = predictions$ci.ub,
    Comparison = comparison_type,
    Metrics = metric_type
  )
  results <- results %>%
    left_join(study_counts, by = "Restoration_strategy") %>%
    mutate(annotation = paste0("(", n_studies, "|", n_observations, ")"))
    return(results)
}
```

### Alpha diversity

```{r}
# Observed richness Restored vs Degraded
OTU_deg_model <- rma.mv(yi, vi, mods = ~ Restoration_strategy,random = ~ 1 | ID, data = a_OTU_resVsdeg)
OTU_deg_model

# Observed richness Restored vs Reference
OTU_ref_model <-rma.mv(yi, vi, mods = ~ Restoration_strategy, random = ~ 1 | ID, data = a_OTU_resVsref) 
OTU_ref_model

# Chao1 richness Restored vs Degraded
Chao_deg_model <- rma.mv(yi, vi, mods = ~ Restoration_strategy, random = ~ 1 | ID, data = a_Chao_resVsdeg)
Chao_deg_model

# Chao1 richness Restored vs Reference
Chao_ref_model <- rma.mv(yi, vi, mods = ~ Restoration_strategy, random = ~ 1 | ID, data = a_Chao_resVsref)
Chao_ref_model

# Shannon index Restored vs Degraded
Shannon_deg_model <- rma.mv(yi, vi, mods = ~ Restoration_strategy, random = ~ 1 | ID, data = a_Shannon_resVsdeg)
Shannon_deg_model

# Shannon index Restored vs Reference
Shannon_ref_model <- rma.mv(yi, vi, mods = ~ Restoration_strategy, random = ~ 1 | ID, data = a_Shannon_resVsref)
Shannon_ref_model

# Simpson index Restored vs Degraded
Simpson_deg_model <- rma.mv(yi, vi, mods = ~ Restoration_strategy, random = ~ 1 | ID, data = a_Simpson_resVsdeg)
Simpson_deg_model

# Simpson index Restored vs Reference
Simpson_ref_model <- rma.mv(yi, vi, mods = ~ Restoration_strategy, random = ~ 1 | ID, data = a_Simpson_resVsref)
Simpson_ref_model

# Get predictions dataset
OTU_deg_predictions <- get_predictions(OTU_deg_model, a_OTU_resVsdeg, "Restored vs Degraded", "Observed richness")
OTU_ref_predictions <- get_predictions(OTU_ref_model, a_OTU_resVsref, "Restored vs Reference", "Observed richness")
Chao_deg_predictions <- get_predictions(Chao_deg_model, a_Chao_resVsdeg, "Restored vs Degraded", "Chao1 richness")
Chao_ref_predictions <- get_predictions(Chao_ref_model, a_Chao_resVsref, "Restored vs Reference", "Chao1 richness")
Shannon_deg_predictions <- get_predictions(Shannon_deg_model, a_Shannon_resVsdeg, "Restored vs Degraded", "Shannon index")
Shannon_ref_predictions <- get_predictions(Shannon_ref_model, a_Shannon_resVsref, "Restored vs Reference", "Shannon index")
Simpson_deg_predictions <- get_predictions(Simpson_deg_model, a_Simpson_resVsdeg, "Restored vs Degraded", "Simpson index")
Simpson_ref_predictions <- get_predictions(Simpson_ref_model, a_Simpson_resVsref, "Restored vs Reference", "Simpson index")
all_predictions_alpha_diversity <- bind_rows(OTU_deg_predictions, OTU_ref_predictions, Chao_deg_predictions, Chao_ref_predictions, Shannon_deg_predictions, Shannon_ref_predictions, Simpson_deg_predictions, Simpson_ref_predictions)

# change to % Change
all_predictions_alpha_diversity <- all_predictions_alpha_diversity %>% mutate(pred_pct = pred * 100, ci.lb_pct = ci.lb * 100, ci.ub_pct = ci.ub * 100)

all_predictions_alpha_diversity <- all_predictions_alpha_diversity %>% mutate(Parameter = "Alpha diversity")
```

```{r}
# Plots
all_predictions_alpha_diversity$Metrics <- factor (all_predictions_alpha_diversity$Metrics, levels = c("Simpson index", "Shannon index", "Chao1 richness", "Observed richness"))

combined_data_filtered$Metrics <- factor (combined_data_filtered$Metrics, levels = c("Simpson index", "Shannon index", "Chao1 richness", "Observed richness"))

alpha_diversity_restoration_deg_plot <- ggplot() + geom_vline(xintercept = 0, linetype = "dashed", color = "grey60") + geom_point(data = combined_data_filtered %>% filter(Comparison == "Restored vs Degraded"), aes(x = yi_pct, y = Metrics, fill = Restoration_strategy), position = position_jitterdodge(jitter.width = 0.1, jitter.height = 0.1, dodge.width = 0.8), alpha = 0.2, size = 3, shape = 21, stroke = 0.1, color = "black") + geom_pointrange(data = all_predictions_alpha_diversity %>% filter(Comparison == "Restored vs Degraded"), aes(x = pred_pct, y = Metrics, xmin = ci.lb_pct, xmax = ci.ub_pct, group = Restoration_strategy), color = "black", size = 0.5, shape = 1, linewidth = 0.5, stroke = 0.5, fill = "black", position = position_dodge(width = 0.8)) + scale_fill_manual(values = c("Active" = "#F8766D", "Passive" = "#7CAE00")) + coord_cartesian(xlim = c(-80, 120)) + labs(x = "% Change (Alpha diversity)", y = NULL) + theme_bw() + theme(legend.position = "none", axis.ticks.y = element_blank(), axis.text.y = element_blank(), plot.title = element_text(hjust = 0.5, face = "plain", size = 14), axis.title = element_text(face = "plain", size = 12), axis.text = element_text(size = 10, color = "black"), panel.grid.major = element_line(color = "transparent"), panel.grid.minor = element_blank(), panel.border = element_rect(color = "black", fill = NA))
alpha_diversity_restoration_deg_plot

alpha_diversity_restoration_ref_plot <- ggplot() + geom_vline(xintercept = 0, linetype = "dashed", color = "grey60") + geom_point(data = combined_data_filtered %>% filter(Comparison == "Restored vs Reference"), aes(x = yi_pct, y = Metrics, fill = Restoration_strategy), position = position_jitterdodge(jitter.width = 0.1, jitter.height = 0.1, dodge.width = 0.8), alpha = 0.2, size = 3, shape = 21, stroke = 0.1, color = "black") + geom_pointrange(data = all_predictions_alpha_diversity %>% filter(Comparison == "Restored vs Reference"), aes(x = pred_pct, y = Metrics, xmin = ci.lb_pct, xmax = ci.ub_pct, group = Restoration_strategy), color = "black", size = 0.5, shape = 1, linewidth = 0.5, stroke = 0.5, fill = "black", position = position_dodge(width = 0.8)) + scale_fill_manual(values = c("Active" = "#F8766D", "Passive" = "#7CAE00")) + labs(x = "% Change (Alpha diversity)", y = NULL) + theme_bw() + theme(legend.position = "none", axis.ticks.y = element_blank(), axis.text.y = element_blank(), plot.title = element_text(hjust = 0.5, face = "plain", size = 14), axis.title = element_text(face = "plain", size = 12), axis.text = element_text(size = 10, color = "black"), panel.grid.major = element_line(color = "transparent"), panel.grid.minor = element_blank(), panel.border = element_rect(color = "black", fill = NA))
alpha_diversity_restoration_ref_plot
```

### Composition

```{r}
# Beta diversity Restored vs Degraded
beta_deg_model <- rma.mv(yi, vi, mods = ~ Restoration_strategy, random = ~ 1 | ID, data = beta_diversity_degraded)
beta_deg_model

# Beta diversity Restored vs Reference
beta_ref_model <- rma.mv(yi, vi, mods = ~ Restoration_strategy, random = ~ 1 | ID, data = beta_diversity_reference)
beta_ref_model

# Community structure Restored vs Degraded
structure_deg_model <- rma.mv(yi, vi, mods = ~ Restoration_strategy, random = ~ 1 | ID, data = structure_degraded)
structure_deg_model

# Community structure Restored vs Reference
structure_ref_model <- rma.mv(yi, vi, mods = ~ Restoration_strategy, random = ~ 1 | ID, data = structure_reference)
structure_ref_model

# Get predictions dataset
beta_deg_predictions <- get_predictions(beta_deg_model, beta_diversity_degraded, "Restored vs Degraded", "Beta diversity")
beta_ref_predictions <- get_predictions(beta_ref_model, beta_diversity_reference, "Restored vs Reference", "Beta diversity")
comp_deg_predictions <- get_predictions(structure_deg_model, structure_degraded, "Restored vs Degraded", "Community structure")
comp_ref_predictions <- get_predictions(structure_ref_model, structure_reference, "Restored vs Reference", "Community structure")
all_predictions_composition <- bind_rows(beta_deg_predictions,beta_ref_predictions,comp_deg_predictions,comp_ref_predictions)
all_predictions_composition <- all_predictions_composition %>% mutate(pred_pct = pred * 100, ci.lb_pct = ci.lb * 100, ci.ub_pct = ci.ub * 100)

# change to % Change
all_predictions_composition <- all_predictions_composition %>% mutate(Parameter = "Composition")
```

```{r}
# Plots
composition_raw_combined <- composition_raw_combined %>% mutate(Metrics = recode(Metrics, "Structure" = "Community structure"))

all_predictions_composition$Metrics <- factor (all_predictions_composition$Metrics, levels = c("Community structure", "Beta diversity"))
composition_raw_combined$Metrics <- factor (composition_raw_combined$Metrics, levels = c("Community structure", "Beta diversity"))

composition_restoration_deg_plot <- ggplot() + geom_vline(xintercept = 0, linetype = "dashed", color = "grey60") + geom_point(data = composition_raw_combined %>% filter(Comparison == "Restored vs Degraded"), aes(x = yi_pct, y = Metrics, fill = Restoration_strategy), position = position_jitterdodge(jitter.width = 0.1, jitter.height = 0.1, dodge.width = 0.8), alpha = 0.2, size = 3, shape = 21, stroke = 0.1, color = "black") + geom_pointrange(data = all_predictions_composition %>% filter(Comparison == "Restored vs Degraded"), aes(x = pred_pct, y = Metrics, xmin = ci.lb_pct, xmax = ci.ub_pct, group = Restoration_strategy), color = "black", size = 0.5, shape = 1, linewidth = 0.5, stroke = 0.5, fill = "black", position = position_dodge(width = 0.8)) + scale_fill_manual(values = c("Active" = "#F8766D", "Passive" = "#7CAE00")) + coord_cartesian(xlim = c(-100, 380)) + labs(x = "% Change (Composition)", y = NULL) + theme_bw() + theme(legend.position = "none", axis.ticks.y = element_blank(), axis.text.y = element_blank(), plot.title = element_text(hjust = 0.5, face = "plain", size = 14), axis.title = element_text(face = "plain", size = 12), axis.text = element_text(size = 10, color = "black"), panel.grid.major = element_line(color = "transparent"), panel.grid.minor = element_blank(), panel.border = element_rect(color = "black", fill = NA))
composition_restoration_deg_plot

composition_restoration_ref_plot <- ggplot() + geom_vline(xintercept = 0, linetype = "dashed", color = "grey60") + geom_point(data = composition_raw_combined %>% filter(Comparison == "Restored vs Reference"), aes(x = yi_pct, y = Metrics, fill = Restoration_strategy), position = position_jitterdodge(jitter.width = 0.1, jitter.height = 0.1, dodge.width = 0.8), alpha = 0.2, size = 3, shape = 21, stroke = 0.1, color = "black") + geom_pointrange(data = all_predictions_composition %>% filter(Comparison == "Restored vs Reference"), aes(x = pred_pct, y = Metrics, xmin = ci.lb_pct, xmax = ci.ub_pct, group = Restoration_strategy), color = "black", size = 0.5, shape = 1, linewidth = 0.5, stroke = 0.5, fill = "black", position = position_dodge(width = 0.8)) + scale_fill_manual(values = c("Active" = "#F8766D", "Passive" = "#7CAE00")) + coord_cartesian(xlim = c(-100, 305)) + labs(x = "% Change (Composition)", y = NULL) + theme_bw() + theme(legend.position = "none", axis.ticks.y = element_blank(), axis.text.y = element_blank(), plot.title = element_text(hjust = 0.5, face = "plain", size = 14), axis.title = element_text(face = "plain", size = 12), axis.text = element_text(size = 10, color = "black"), panel.grid.major = element_line(color = "transparent"), panel.grid.minor = element_blank(), panel.border = element_rect(color = "black", fill = NA))

composition_restoration_ref_plot
```

### Relative abundance

```{r}
# Ascomycota Restored vs Degraded
Ascomycota_deg_model <- rma.mv(yi, vi, mods = ~ Restoration_strategy, random = ~ 1 | ID, data = a_Ascomycota_degraded)
Ascomycota_deg_model

# Ascomycota Restored vs Reference
Ascomycota_ref_model <- rma.mv(yi, vi, mods = ~ Restoration_strategy, random = ~ 1 | ID, data = a_Ascomycota_reference)
Ascomycota_ref_model

# Basidiomycota Restored vs Degraded
Basidiomycota_deg_model <- rma.mv(yi, vi, mods = ~ Restoration_strategy, random = ~ 1 | ID, data = a_Basidiomycota_degraded)
Basidiomycota_deg_model

# Basidiomycota Restored vs Reference
Basidiomycota_ref_model <- rma.mv(yi, vi, mods = ~ Restoration_strategy, random = ~ 1 | ID, data = a_Basidiomycota_reference)
Basidiomycota_ref_model

# Get prediction dataset
Ascomycota_deg_predictions <- get_predictions(Ascomycota_deg_model, a_Ascomycota_degraded, "Restored vs Degraded", "Ascomycota")
Ascomycota_ref_predictions <- get_predictions(Ascomycota_ref_model, a_Ascomycota_reference, "Restored vs Reference", "Ascomycota")
Basidiomycota_deg_predictions <- get_predictions(Basidiomycota_deg_model, a_Basidiomycota_degraded, "Restored vs Degraded",  "Basidiomycota")
Basidiomycota_ref_predictions <- get_predictions(Basidiomycota_ref_model, a_Basidiomycota_reference, "Restored vs Reference", "Basidiomycota")
all_predictions_abundance <- bind_rows(Ascomycota_deg_predictions, Ascomycota_ref_predictions, Basidiomycota_deg_predictions, Basidiomycota_ref_predictions)

# change to % Change
all_predictions_abundance <- all_predictions_abundance %>% mutate(pred_pct = pred * 100, ci.lb_pct = ci.lb * 100, ci.ub_pct = ci.ub * 100)

all_predictions_abundance <- all_predictions_abundance %>% mutate(Parameter = "Relative abundance")
head(all_predictions_abundance)
```

```{r}
# Plots
all_predictions_abundance$Metrics <- factor (all_predictions_abundance$Metrics, levels = c("Basidiomycota", "Ascomycota"))
abundance_raw_combined$Metrics <- factor (abundance_raw_combined$Metrics, levels = c("Basidiomycota", "Ascomycota"))

abundance_restoration_deg_plot <- ggplot() + geom_vline(xintercept = 0, linetype = "dashed", color = "grey60") + geom_point(data = abundance_raw_combined %>% filter(Comparison == "Restored vs Degraded"), aes(x = yi_pct, y = Metrics, fill = Restoration_strategy), position = position_jitterdodge(jitter.width = 0.1, jitter.height = 0.1, dodge.width = 0.8), alpha = 0.2, size = 3, shape = 21, stroke = 0.1, color = "black") + geom_pointrange(data = all_predictions_abundance %>% filter(Comparison == "Restored vs Degraded"), aes(x = pred_pct, y = Metrics, xmin = ci.lb_pct, xmax = ci.ub_pct, group = Restoration_strategy), color = "black", size = 0.5, shape = 1, linewidth = 0.5, stroke = 0.5, fill = "black", position = position_dodge(width = 0.8)) + scale_fill_manual(values = c("Active" = "#F8766D", "Passive" = "#7CAE00")) + coord_cartesian(xlim = c(-100, 400)) + labs(x = "% Change (Relative abundance)", y = NULL) + theme_bw() + theme(legend.position = "none", axis.ticks.y = element_blank(), axis.text.y = element_blank(), plot.title = element_text(hjust = 0.5, face = "plain", size = 14), axis.title = element_text(face = "plain", size = 12), axis.text = element_text(size = 10, color = "black"), panel.grid.major = element_line(color = "transparent"), panel.grid.minor = element_blank(), panel.border = element_rect(color = "black", fill = NA))
abundance_restoration_deg_plot

abundance_restoration_ref_plot <- ggplot() + geom_vline(xintercept = 0, linetype = "dashed", color = "grey60") + geom_point(data = abundance_raw_combined %>% filter(Comparison == "Restored vs Reference"), aes(x = yi_pct, y = Metrics, fill = Restoration_strategy), position = position_jitterdodge(jitter.width = 0.1, jitter.height = 0.1, dodge.width = 0.8), alpha = 0.2, size = 3, shape = 21, stroke = 0.1, color = "black") + geom_pointrange(data = all_predictions_abundance %>% filter(Comparison == "Restored vs Reference"), aes(x = pred_pct, y = Metrics, xmin = ci.lb_pct, xmax = ci.ub_pct, group = Restoration_strategy), color = "black", size = 0.5, shape = 1, linewidth = 0.5, stroke = 0.5, fill = "black", position = position_dodge(width = 0.8)) + scale_fill_manual(values = c("Active" = "#F8766D", "Passive" = "#7CAE00")) + coord_cartesian(xlim = c(-100, 300)) + labs(x = "% Change (Relative abundance)", y = NULL) + theme_bw() + theme(legend.position = "none", axis.ticks.y = element_blank(), axis.text.y = element_blank(), plot.title = element_text(hjust = 0.5, face = "plain", size = 14), axis.title = element_text(face = "plain", size = 12), axis.text = element_text(size = 10, color = "black"), panel.grid.major = element_line(color = "transparent"), panel.grid.minor = element_blank(), panel.border = element_rect(color = "black", fill = NA))
abundance_restoration_ref_plot
```

### Biomass

```{r}
# PLFA content Restored vs Degraded
plfa_deg_restoration_model <- rma.mv(yi, vi, mods = ~ Restoration_strategy, random = ~ 1 | ID, data = a_PLFA_degraded)
plfa_deg_restoration_model

# PLFA content Restored vs Reference
plfa_ref_restoration_model <- rma.mv(yi, vi, mods = ~ Restoration_strategy, random = ~ 1 | ID, data = a_PLFA_reference)
plfa_ref_restoration_model

# Get prediction dataset
plfa_deg_predictions <- get_predictions(plfa_deg_restoration_model, a_PLFA_degraded, "Restored vs Degraded", "PLFA content")
plfa_ref_predictions <- get_predictions(plfa_ref_restoration_model, a_PLFA_reference, "Restored vs Reference", "PLFA content")
all_predictions_plfa <- bind_rows(plfa_deg_predictions, plfa_ref_predictions)

# change to % Change
all_predictions_plfa <- all_predictions_plfa %>% mutate(pred_pct = pred * 100, ci.lb_pct = ci.lb * 100, ci.ub_pct = ci.ub * 100)
all_predictions_plfa <- all_predictions_plfa %>% mutate(Parameter = "Biomass")
head(all_predictions_plfa)
```

```{r}
# Plot
plfa_restoration_deg_plot <- ggplot() + geom_vline(xintercept = 0, linetype = "dashed", color = "grey60") + geom_point(data = plfa_raw_combined %>% filter(Comparison == "Restored vs Degraded"), aes(x = yi_pct, y = Metrics, fill = Restoration_strategy), position = position_jitterdodge(jitter.width = 0.1, jitter.height = 0.1, dodge.width = 0.8), alpha = 0.5, size = 3, shape = 21, stroke = 0.1, color = "black") + geom_pointrange(data = all_predictions_plfa %>% filter(Comparison == "Restored vs Degraded"), aes(x = pred_pct, y = Metrics, xmin = ci.lb_pct, xmax = ci.ub_pct, group = Restoration_strategy), color = "black", size = 0.5, shape = 1, linewidth = 0.5, stroke = 0.5, fill = "black", position = position_dodge(width = 0.8)) + scale_fill_manual(values = c("Active" = "#F8766D", "Passive" = "#7CAE00")) + coord_cartesian(xlim = c(-100, 300)) + labs(x = "% Change (Biomass)", y = NULL) + theme_bw() + theme(legend.position = "none", axis.ticks.y = element_blank(), axis.text.y = element_blank(), plot.title = element_text(hjust = 0.5, face = "plain", size = 14), axis.title = element_text(face = "plain", size = 12), axis.text = element_text(size = 10, color = "black"), panel.grid.major = element_line(color = "transparent"), panel.grid.minor = element_blank(), panel.border = element_rect(color = "black", fill = NA))

plfa_restoration_ref_plot <- ggplot() + geom_vline(xintercept = 0, linetype = "dashed", color = "grey60") + geom_point(data = plfa_raw_combined %>% filter(Comparison == "Restored vs Reference"), aes(x = yi_pct, y = Metrics, fill = Restoration_strategy), position = position_jitterdodge(jitter.width = 0.1, jitter.height = 0.1, dodge.width = 0.8), alpha = 0.5, size = 3, shape = 21, stroke = 0.1, color = "black") + geom_pointrange(data = all_predictions_plfa %>% filter(Comparison == "Restored vs Reference"), aes(x = pred_pct, y = Metrics, xmin = ci.lb_pct, xmax = ci.ub_pct, group = Restoration_strategy), color = "black", size = 0.5, shape = 1, linewidth = 0.5, stroke = 0.5, fill = "black", position = position_dodge(width = 0.8)) + scale_fill_manual(values = c("Active" = "#F8766D", "Passive" = "#7CAE00")) + labs(x = "% Change (Biomass)", y = NULL) + theme_bw() + theme(legend.position = "none", axis.ticks.y = element_blank(), axis.text.y = element_blank(), plot.title = element_text(hjust = 0.5, face = "plain", size = 14), axis.title = element_text(face = "plain", size = 12), axis.text = element_text(size = 10, color = "black"), panel.grid.major = element_line(color = "transparent"), panel.grid.minor = element_blank(), panel.border = element_rect(color = "black", fill = NA))
```

### Figure 3

##### Legends for figures

```{r}
plot_with_legend <- ggplot() + geom_vline(xintercept = 0, linetype = "dashed", color = "grey60") + geom_point(data = combined_data_filtered %>% filter(Comparison == "Restored vs Degraded"), aes(x = yi_pct, y = Metrics, fill = Restoration_strategy), position = position_jitterdodge(jitter.width = 0.2, jitter.height = 0.1, dodge.width = 0.8), alpha = 0.5, size = 3, shape = 21, stroke = 0.1, color = "black") + theme_bw() + scale_fill_manual(values = c("Active" = "#F8766D", "Passive" = "#7CAE00"), name = "Restoration strategy", labels = c("Active" = "Active restoration", "Passive" = "Natural regeneration")) + theme(legend.position = "bottom", panel.grid.major = element_line(color = "transparent"), panel.grid.minor = element_blank(), panel.border = element_rect(color = "black", fill = NA), legend.text = element_text(size = 12)); plot_with_legend

# Extract the legend
get_legend <- function(plot) {
  grob_table <- ggplot_gtable(ggplot_build(plot))
  legend_index <- which(sapply(grob_table$grobs, function(x) x$name) == "guide-box")
  legend <- grob_table$grobs[[legend_index]]
  return(legend)
}
legend <- get_legend(plot_with_legend)
```

##### Combine figures

```{r}
Figure_3_deg1 <- grid.arrange(alpha_diversity_restoration_deg_plot, plfa_restoration_ref_plot, nrow = 2, heights = c(1, 0.4))
Figure_3_deg2 <- grid.arrange(abundance_restoration_deg_plot, composition_restoration_deg_plot, nrow = 2, heights = c(1, 1))
Figure_3_ref4 <- grid.arrange(alpha_diversity_restoration_ref_plot, plfa_restoration_ref_plot, nrow = 2, heights = c(1, 0.4))
Figure_3_ref5 <- grid.arrange(abundance_restoration_ref_plot, composition_restoration_ref_plot, nrow = 2, heights = c(1, 1))
```

```{r}
Figure_3_deg3 <- grid.arrange(Figure_3_deg1, Figure_3_deg2, legend, ncol = 2, nrow = 2, layout_matrix = rbind(c(1, 2), c(3, 3)), heights = c(10, 1),  top = textGrob("Restored vs Degraded", gp = gpar(fontsize = 12, fontface = "bold")))
Figure_3_deg3
Figure_3_ref6 <- grid.arrange(Figure_3_ref4, Figure_3_ref5, legend, ncol = 2, nrow = 2, layout_matrix = rbind(c(1, 2), c(3, 3)), heights = c(10, 1), top = textGrob("Restored vs Reference", gp = gpar(fontsize = 12, fontface = "bold")))
Figure_3_ref6
```

##### Save figures

```{r eval = FALSE}
ggsave("figure_3.1.jpg",combined_plot_deg13, dpi = 600, height = 8, width = 5)
ggsave("figure_3.2.jpg", combined_plot_ref16, dpi = 600, height = 8, width = 5)
```

# [Chapter XI]{style="color: blue;"}

## Effect of restoration time

#### Function for predicted value

```{r}
get_time_predictions <- function(model, dataset)
{time_seq <- seq(min(dataset$Restoration_time), max(dataset$Restoration_time), length.out = 50)
  pred <- predict(model, newmods = time_seq)
  data.frame(Restoration_time = time_seq, pred = pred$pred, ci.lb = pred$ci.lb, ci.ub = pred$ci.ub)
}
```

### Alpha diversity

```{r}
# Observed richness Restored vs Degraded
OTU_deg_model <- rma.mv(yi, vi, mods = ~ Restoration_time, random = ~ 1 | ID, data = a_OTU_resVsdeg)

# Observed richness Restored vs Reference
OTU_ref_model <-rma.mv(yi, vi, mods = ~ Restoration_time, random = ~ 1 | ID, data = a_OTU_resVsref)

# Chao1 richness Restored vs Degraded
Chao_deg_model <- rma.mv(yi, vi, mods = ~ Restoration_time, random = ~ 1 | ID, data = a_Chao_resVsdeg)

# Chao1 richness Restored vs Reference
Chao_ref_model <- rma.mv(yi, vi, mods = ~ Restoration_time, random = ~ 1 | ID, data = a_Chao_resVsref)

# Shannon index Restored vs Degraded
Shannon_deg_model <- rma.mv(yi, vi, mods = ~ Restoration_time, random = ~ 1 | ID, data = a_Shannon_resVsdeg)

# Shannon index Restored vs Reference
Shannon_ref_model <- rma.mv(yi, vi, mods = ~ Restoration_time, random = ~ 1 | ID, data = a_Shannon_resVsref)

# Simpson index Restored vs Degraded
Simpson_deg_model <- rma.mv(yi, vi, mods = ~ Restoration_time, random = ~ 1 | ID, data = a_Simpson_resVsdeg)

# Simpson index Restored vs Reference
Simpson_ref_model <- rma.mv(yi, vi, mods = ~ Restoration_time, random = ~ 1 | ID, data = a_Simpson_resVsref)

# Get prediction dataset
OTU_deg_predictions_time <- get_time_predictions(OTU_deg_model, a_OTU_resVsdeg)
OTU_ref_predictions_time <- get_time_predictions(OTU_ref_model, a_OTU_resVsref)
Chao_deg_predictions_time <- get_time_predictions(Chao_deg_model, a_Chao_resVsdeg)
Chao_ref_predictions_time <- get_time_predictions(Chao_ref_model, a_Chao_resVsref)
Shannon_deg_predictions_time <- get_time_predictions(Shannon_deg_model, a_Shannon_resVsdeg)
Shannon_ref_predictions_time <- get_time_predictions(Shannon_ref_model, a_Shannon_resVsref)
Simpson_deg_predictions_time <- get_time_predictions(Simpson_deg_model, a_Simpson_resVsdeg)
Simpson_ref_predictions_time <- get_time_predictions(Simpson_ref_model, a_Simpson_resVsref)

OTU_deg_predictions_time$Comparison <- "Restored vs Degraded"
OTU_deg_predictions_time$Metrics <- "Observed richness"
OTU_ref_predictions_time$Comparison <- "Restored vs Reference"
OTU_ref_predictions_time$Metrics <- "Observed richness"
Chao_deg_predictions_time$Comparison <- "Restored vs Degraded"
Chao_deg_predictions_time$Metrics <- "Chao1 richness"
Chao_ref_predictions_time$Comparison <- "Restored vs Reference"
Chao_ref_predictions_time$Metrics <- "Chao1 richness"
Shannon_deg_predictions_time$Comparison <- "Restored vs Degraded"
Shannon_deg_predictions_time$Metrics <- "Shannon index"
Shannon_ref_predictions_time$Comparison <- "Restored vs Reference"
Shannon_ref_predictions_time$Metrics <- "Shannon index"
Simpson_deg_predictions_time$Comparison <- "Restored vs Degraded"
Simpson_deg_predictions_time$Metrics <- "Simpson index"
Simpson_ref_predictions_time$Comparison <- "Restored vs Reference"
Simpson_ref_predictions_time$Metrics <- "Simpson index"

alpha_time_predictions_deg <- rbind(OTU_deg_predictions_time, Chao_deg_predictions_time, Shannon_deg_predictions_time, Simpson_deg_predictions_time)%>% mutate(Parameter = "Alpha diversity")

alpha_time_predictions_ref <- rbind(OTU_ref_predictions_time, Chao_ref_predictions_time, Shannon_ref_predictions_time, Simpson_ref_predictions_time)%>% mutate(Parameter = "Alpha diversity")

alpha_time_predictions_deg <- alpha_time_predictions_deg[-c(394,408, 717), ]

alpha_diversity_deg_raw_time <- alpha_diversity_deg_raw %>% mutate(Parameter = "Alpha diversity") %>% select(yi, vi, Restoration_time, Metrics, Comparison, Parameter)

alpha_diversity_ref_raw_time <- alpha_diversity_ref_raw %>% mutate(Parameter = "Alpha diversity") %>% select(yi, vi, Restoration_time, Metrics, Comparison, Parameter)
```

### Composition

```{r}
# Beta diversity Restored vs Degraded
beta_deg_model <- rma.mv(yi, vi, mods = ~ Restoration_time, random = ~ 1 | ID, data = beta_diversity_degraded)
beta_deg_model

# Beta diversity Restored vs Reference
beta_ref_model <- rma.mv(yi, vi, mods = ~ Restoration_time , random = ~ 1 | ID, data = beta_diversity_reference)
beta_ref_model

# Community structure Restored vs Degraded
structure_deg_model <- rma.mv(yi, vi, mods = ~ Restoration_time , random = ~ 1 | ID, data = structure_degraded)
structure_deg_model

# Community structure Restored vs Reference
structure_ref_model <- rma.mv(yi, vi, mods = ~ Restoration_time , random = ~ 1 | ID, data = structure_reference)
structure_ref_model

# Get prediction dataset
beta_deg_pred <- get_time_predictions(beta_deg_model, beta_diversity_degraded)
structure_deg_pred <- get_time_predictions(structure_deg_model, structure_degraded)

beta_deg_pred$Metrics <- "Beta diversity"
beta_deg_pred$Comparison <- "Restored vs Degraded"
structure_deg_pred$Metrics <- "Community structure"
structure_deg_pred$Comparison <- "Restored vs Degraded"
composition_time_predictions_deg <- rbind(beta_deg_pred, structure_deg_pred)%>% mutate(Parameter = "Composition")
beta_ref_pred <- get_time_predictions(beta_ref_model, beta_diversity_reference)
structure_ref_pred <- get_time_predictions(structure_ref_model, structure_reference)

beta_ref_pred$Metrics <- "Beta diversity"
beta_ref_pred$Comparison <- "Restored vs Reference"
structure_ref_pred$Metrics <- "Community structure"
structure_ref_pred$Comparison <- "Restored vs Reference"
composition_time_predictions_ref <- rbind(beta_ref_pred, structure_ref_pred)%>% mutate(Parameter = "Composition")

composition_raw_degraded_time <- composition_raw_degraded %>%mutate(Parameter = "Alpha diversity") %>%
  select(yi, vi, Restoration_time, Metrics, Comparison, Parameter)

composition_raw_ref_time <- composition_raw_reference %>%mutate(Parameter = "Alpha diversity") %>%
  select(yi, vi, Restoration_time, Metrics, Comparison, Parameter)
```

### Relative abundance

```{r}
# Ascomycota Restored vs Degraded
Asco_restoration_deg_model <- rma.mv(yi, vi, mods = ~ Restoration_time, random = ~ 1 | ID,  data = a_Ascomycota_degraded)
Asco_restoration_deg_model

# Ascomycota Restored vs Reference
Asco_restoration_ref_model <- rma.mv(yi, vi, mods = ~ Restoration_time , random = ~ 1 | ID,  data = a_Ascomycota_reference)
Asco_restoration_ref_model

# Basidiomycota Restored vs Degraded
Basidio_restoration_deg_model <- rma.mv(yi, vi, mods = ~ Restoration_time , random = ~ 1 | ID, data = a_Basidiomycota_degraded)
Basidio_restoration_deg_model

# Basidiomycota Restored vs Reference
Basidio_restoration_ref_model <- rma.mv(yi, vi, mods = ~ Restoration_time , random = ~ 1 | ID, data = a_Basidiomycota_reference)
Basidio_restoration_ref_model

# Get prediction dataset
Ascomycota_deg_pred <- get_time_predictions(Asco_restoration_deg_model,a_Ascomycota_degraded)
Basidiomycota_deg_pred <- get_time_predictions(Basidio_restoration_deg_model, a_Basidiomycota_degraded)
Ascomycota_ref_pred <- get_time_predictions(Asco_restoration_ref_model, a_Ascomycota_reference)
Basidiomycota_ref_pred <- get_time_predictions(Basidio_restoration_ref_model, a_Basidiomycota_reference)

Ascomycota_deg_pred$Metrics <- "Ascomycota"
Ascomycota_deg_pred$Comparison <- "Restored vs Degraded"
Ascomycota_ref_pred$Metrics <- "Ascomycota"
Ascomycota_ref_pred$Comparison <- "Restored vs Reference"
Basidiomycota_deg_pred$Metrics <- "Basidiomycota"
Basidiomycota_deg_pred$Comparison <- "Restored vs Degraded"
Basidiomycota_ref_pred$Metrics <- "Basidiomycota"
Basidiomycota_ref_pred$Comparison <- "Restored vs Reference"
abundance_time_predictions_deg <- rbind(Ascomycota_deg_pred, Basidiomycota_deg_pred)%>% mutate(Parameter = "Relative abundance")
abundance_time_predictions_ref <- rbind(Ascomycota_ref_pred, Basidiomycota_ref_pred)%>% mutate(Parameter = "Relative abundance")

Ascomycota_Basidiomycota_deg_raw_time <- Ascomycota_Basidiomycota_deg_raw %>% mutate(Parameter = "Alpha diversity") %>%  select(yi, vi, Restoration_time, Metrics, Comparison, Parameter)

Ascomycota_Basidiomycota_ref_raw_time <- Ascomycota_Basidiomycota_ref_raw %>% mutate(Parameter = "Alpha diversity") %>%  select(yi, vi, Restoration_time, Metrics, Comparison, Parameter)
```

### Biomass

```{r}
# PLFA content Restored vs Degraded
plfa_deg_model <- rma.mv(yi, vi, mods = ~ Restoration_time, random = ~ 1 | ID, data = a_PLFA_degraded)
plfa_deg_model

# PLFA content Restored vs Reference
plfa_ref_model <- rma.mv(yi, vi, mods = ~ Restoration_time , random = ~ 1 | ID, data = a_PLFA_reference)
plfa_ref_model

# Get prediction dataset
plfa_deg_pred <- get_time_predictions(plfa_deg_model, a_PLFA_degraded)
plfa_ref_pred <- get_time_predictions(plfa_ref_model, a_PLFA_reference)
plfa_deg_pred$Metrics <- "PLFA content"
plfa_deg_pred$Comparison <- "Restored vs Degraded"
plfa_ref_pred$Metrics <- "PLFA content"
plfa_ref_pred$Comparison <- "Restored vs Degraded"
plfa_deg_pred%>% mutate(Parameter = "Biomass")
plfa_ref_pred%>% mutate(Parameter = "Biomass")

a_PLFA_reference_time <- a_PLFA_reference %>% mutate(Parameter = "Alpha diversity") %>% select(yi, vi, Restoration_time, Metrics, Comparison, Parameter)

a_PLFA_degraded_time <- a_PLFA_degraded %>% mutate(Parameter = "Alpha diversity") %>% select(yi, vi, Restoration_time, Metrics, Comparison, Parameter)
```

### Figure 4

```{r}
# Plots
composition_raw_degraded_time <- composition_raw_degraded_time %>% mutate(Metrics = recode(Metrics, "Structure" = "Community structure"))

time_raw <- rbind(alpha_diversity_deg_raw_time, composition_raw_degraded_time, Ascomycota_Basidiomycota_deg_raw_time, a_PLFA_degraded_time)%>%slice(-408)

time_raw$Metrics <- factor(time_raw$Metrics, levels = c("Observed richness","Chao1 richness","Shannon index","Simpson index","Ascomycota","Basidiomycota","Beta diversity","Community structure","PLFA content"))

time_combined_deg <- bind_rows(alpha_time_predictions_deg, composition_time_predictions_deg, abundance_time_predictions_deg, plfa_deg_pred)

time_combined_deg$Metrics <- factor(time_combined_deg$Metrics, levels = c("Observed richness","Chao1 richness","Shannon index","Simpson index","Ascomycota","Basidiomycota","Beta diversity","Community structure","PLFA content"))

time_plot_deg <- ggplot(time_combined_deg, aes(Restoration_time, pred)) + geom_hline(yintercept = 0, linetype = "dashed", color = "grey50") + geom_point(data = time_raw, aes(y = yi), alpha = 0.5, size = 3, shape = 21, fill = "orange", color = "black", stroke = 0.2) + geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), alpha = 0.6, fill = "grey60") + geom_line(color = "black", linewidth = 0.5) + labs(title = "Restored vs Degraded", x = "Restoration time (Yrs)", y = "lnRR") + theme_bw(base_size = 12) + theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 16), panel.grid.minor = element_blank(), panel.grid.major = element_blank(), strip.background = element_rect(fill = "grey95"), strip.text = element_text(size = 14), axis.text = element_text(size = 13), axis.text.x = element_text(size = 16), axis.title = element_text(size = 16)) + facet_wrap(~Metrics, scales = "free")
time_plot_deg
```

```{r}
composition_raw_ref_time <- composition_raw_ref_time %>%mutate(Metrics = recode(Metrics, "Structure" = "Community structure"))

time_ref_raw <- rbind(alpha_diversity_ref_raw_time, composition_raw_ref_time, Ascomycota_Basidiomycota_ref_raw_time, a_PLFA_reference_time)

time_ref_raw$Metrics <- factor(time_ref_raw$Metrics, levels = c("Observed richness","Chao1 richness","Shannon index","Simpson index","Ascomycota","Basidiomycota","Beta diversity","Community structure","PLFA content"))

time_combined_ref <- bind_rows(alpha_time_predictions_ref, composition_time_predictions_ref, abundance_time_predictions_ref, plfa_ref_pred)

time_combined_ref$Metrics <- factor(time_combined_ref$Metrics, levels = c("Observed richness","Chao1 richness","Shannon index","Simpson index","Ascomycota","Basidiomycota","Beta diversity","Community structure","PLFA content"))

time_plot_ref <- ggplot(time_combined_ref, aes(x = Restoration_time, y = pred)) + geom_hline(yintercept = 0, linetype = "dashed", color = "grey50") + geom_point(data = time_ref_raw, aes(y = yi), alpha = 0.5, size = 3, shape = 21, fill = "cyan3", color = "black", stroke = 0.2) + geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), alpha = 0.5, fill = "grey60") + geom_line(color = "black", linewidth = 0.5) + labs(title ="Restored vs Reference", x = "Restoration time (Yrs)", y = "lnRR") + theme_bw(base_size = 12) + theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 16), panel.grid.minor = element_blank(), panel.grid.major = element_blank(), strip.background = element_rect(fill = "grey95"), strip.text = element_text(size = 14), axis.text = element_text(size = 13), axis.text.x = element_text(size = 16), axis.title = element_text(size = 16)) + facet_wrap(~Metrics, scales = "free")
time_plot_ref
```

```{r eval = FALSE}
ggsave("figure_4.1.jpg", time_plot_deg, dpi = 600, height = 9, width = 8)
ggsave("figure_4.2.jpg", time_plot_ref, dpi = 600, height = 9, width = 8)
```

```{r}
sessionInfo()
R.version.string
capture.output(sessionInfo(), file = "sessionInfo.txt")
```
